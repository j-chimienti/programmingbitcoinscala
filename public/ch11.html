<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.9">
<title>Programming Bitcoin</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Programming Bitcoin</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_spv">Simplified Payment Verification</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>The one field that we didn&#8217;t investigate much in the Chapter 9 is the Merkle Root field. The reason is that in order to understand why it&#8217;s useful, we have to learn a few things about what Merkle Trees are and what properties they have. In this chapter, we&#8217;re going to learn exactly what a Merkle Root is. This will be motivated by something called a Proof of Inclusion.</p>
</div>
<div class="sect2">
<h3 id="_motivation">Motivation</h3>
<div class="paragraph">
<p>For a device that doesn&#8217;t have much hard drive space, like your phone, it&#8217;s hard to store the entire blockchain. As of this writing, the entire Bitcoin blockchain is around 170GB, which is a lot more than many phones can handle. If the entire blockchain cannot be put on the phone, what else can we do? Is it possible to create a Bitcoin wallet on a phone without having all the data?</p>
</div>
<div class="paragraph">
<p>For any wallet, there are two scenarios that we&#8217;re concerned with:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Paying someone</p>
</li>
<li>
<p>Getting paid by someone</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are paying someone with your Bitcoin wallet, it is up to the person receiving your Bitcoins to verify that they&#8217;ve been paid. Once they&#8217;ve verified that the transaction has been included in a block sufficiently deep, they&#8217;ll give you the good or service you are expecting in return. Once you&#8217;ve sent the transaction to the other party, there really isn&#8217;t anything for you to do than wait until they give you what you were exchanging the Bitcoins for.</p>
</div>
<div class="paragraph">
<p>When getting paid Bitcoins, however, we have a dilemma. If we are connected and have the full blockchain, we don&#8217;t need to worry as we can observe that the transaction paying us is in a sufficiently buried block at which point we&#8217;d give them our goods or services. If we don&#8217;t have the full blockchain, as with a phone, what can we do?</p>
</div>
<div class="paragraph">
<p>It turns out that the answer lies in the Merkle Root field. As we saw in the last chapter, we can download the block headers and verify that they meet the consensus rules. In this chapter we&#8217;re going to work towards getting proof that a particular transaction is in a block that we know about. Since the block header is secured by proof-of-work, we know that a proof of inclusion in that block means at a minimum, the person creating the block had to expend a good deal of energy to produce it. The rest of this chapter goes into what the proof of inclusion looks like and how to verify it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_tree">Merkle Tree</h3>
<div class="paragraph">
<p>A Merkle Tree is a computer science structure designed for efficient proofs of inclusion. The prerequisite is an ordered list of items and a hash function. In our case, transactions and double_sha256 are what we use. To construct the Merkle Tree, we follow this algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hash all the items of the ordered list with the provided hash function</p>
</li>
<li>
<p>If there is exactly 1 hash, we are done</p>
</li>
<li>
<p>If there is an odd number of hashes, we add a copy of the last hash in the list to the end so that we have an even number.</p>
</li>
<li>
<p>We pair the hashes in order and hash the concatenation to get the parent level. We should have half the number of hashes as before.</p>
</li>
<li>
<p>Go to 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The idea is to come to a single hash that represents all of the hashes. The gist of getting the Merkle Tree looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/merkle1.png" alt="Merkle Tree">
</div>
</div>
<div class="paragraph">
<p>The bottom row is what we call the leaves of the tree. All other nodes besides the leaves are called <strong>internal nodes</strong>. The leaves get combined to produce its <strong>parent level</strong> (H<sub>AB</sub> and H<sub>CD</sub>) and when we calculate the parent level of that, we get the Merkle Root.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll go through each part of this process below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_parent">Merkle Parent</h3>
<div class="paragraph">
<p>Given two hashes, we need some way to produce another hash that represents both of them. As they are ordered, we will call the two hashes the <strong>left</strong> hash and the <strong>right</strong> hash. Tho combination, we call the <strong>parent</strong> hash. The formula for getting the parent is pretty simple:</p>
</div>
<div class="paragraph">
<p>H = Hashing function, P = Parent Hash, L = Left Hash, R = Right Hash</p>
</div>
<div class="paragraph">
<p>P=H(L||R)</p>
</div>
<div class="paragraph">
<p>Note the <code>||</code> symbol is typically used to denote concatenation.</p>
</div>
<div class="paragraph">
<p>The actual calculation in Python is relatively straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import double_sha256
&gt;&gt;&gt; hash1 = bytes.fromhex('c117...')
&gt;&gt;&gt; hash2 = bytes.fromhex('c131...')
&gt;&gt;&gt; parent = double_sha256(hash1 + hash2)
&gt;&gt;&gt; print(parent.hex())
8b30c5ba100f6f2e5ad1e2a742e5020491240f8eb514fe97c713c31718ad7ecd</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, it&#8217;s important to note that we can show that L is included in the parent, P, by revealing R. That is, if someone wanted to prove to us that L was used to produce P, they would show us R and let us know that L is the left child of P. We can then combine L and R to produce P and have proof that L was used to produce P. This is the most basic proof-of-inclusion.</p>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Write the merkle_parent function.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_parent_level">Merkle Parent Level</h3>
<div class="paragraph">
<p>Given an ordered list of more than two hashes, we can calculate an entire list of parents, or what we call the Merkle Parent Level. If we have an even number of hashes, this is straightforward, as we can simply pair them up in order. If we have an odd number of hashes, then we need to do something else as we have a lone hash at the end.</p>
</div>
<div class="paragraph">
<p>The Merkle Tree solution is to simply duplicate the last item. So, for a list like [A, B, C] what we do is add C again to get [A, B, C, C]. At this point, we can calculate the merkle parent of A and B and calculate the merkle parent of C and C to get:</p>
</div>
<div class="paragraph">
<p>Note that since the Merkle Parent always consists of two hashes, we end up with exactly half the number of hashes before, rounded up. The rounding up is because an odd number of hashes is expanded to be one more.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import merkle_parent
&gt;&gt;&gt; hashes = [...]
&gt;&gt;&gt; if len(hashes) % 2 == 1:
...     hashes.append(hashes[-1])  # <b class="conum">(1)</b>
...
&gt;&gt;&gt; parent_level = []
&gt;&gt;&gt; for i in range(0, len(hashes), 2):  # <b class="conum">(2)</b>
...     parent = merkle_parent(hashes[i], hashes[i+1])
...     parent_level.append(parent)
&gt;&gt;&gt; for item in parent_level:
...     print(item.hex())
8b30c5ba100f6f2e5ad1e2a742e5020491240f8eb514fe97c713c31718ad7ecd
7f4e6f9e224e20fda0ae4c44114237f97cd35aca38d83081c9bfd41feb907800
3ecf6115380c77e8aae56660f5634982ee897351ba906a6837d15ebc3a225df0</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This will add the last hash on the list (hashes[-1]) to the end of <code>hashes</code>. This makes the length of <code>hashes</code> even.</p>
</li>
<li>
<p>This is how we skip by two in Python. <code>i</code> will be 0 the first time through the loop, 2 the second, 4 the third and so on.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This will give us a new list of hashes that correspond to the Merkle Parent Level</p>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>merkle_parent_level</code> function.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_root">Merkle Root</h3>
<div class="paragraph">
<p>The process of getting the Merkle Root is to calculate successive Merkle Parent Levels until we get a single hash. If, for example, we have items A through G, we combine to get the parent level:</p>
</div>
<div class="paragraph">
<p>Then we combine to get the parent level again:</p>
</div>
<div class="paragraph">
<p>We are left with just 2 items, which we combine one more time:</p>
</div>
<div class="paragraph">
<p>H(H(A||B)||H(C||D))||H(H(E||F)||H(G||G))</p>
</div>
<div class="paragraph">
<p>The final hash is called the Merkle Root. As each level will halve the number of hashes, this will result in a single item eventually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import merkle_parent_level
&gt;&gt;&gt; hashes = [...]
&gt;&gt;&gt; current_hashes = hashes
&gt;&gt;&gt; while len(current_hashes) &gt; 1:  # <b class="conum">(1)</b>
...     current_hashes = merkle_parent_level(current_hashes)
...
&gt;&gt;&gt; print(current_hashes[0].hex())  # <b class="conum">(2)</b>
acbcab8bcc1af95d8d563b77d24c3d19b18f1486383d75a5085c4e86c86beed6</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We loop until there&#8217;s 1 hash left.</p>
</li>
<li>
<p>We&#8217;ve exited the loop so there should only be 1 item</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>merkle_root</code> function.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_root_in_blocks">Merkle Root in Blocks</h3>
<div class="paragraph">
<p>The way we calculate the merkle root in Blocks should be pretty straightforward, but due to endian-ness issues, this turns out to be a bit counterintuitive. Specifically, we have to calculate the hash of a transaction and use the little-endian ordering as the leaves for the Merkle Tree. After we calculate the Merkle Root, we have to again interpret that in little-endian in order to compare against the Merkle Root stored in the block.</p>
</div>
<div class="paragraph">
<p>In practice, this simply means reversing the hash before we start and reversing the hash at the end.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import merkle_root
&gt;&gt;&gt; tx_hashes = [...]
&gt;&gt;&gt; hashes = [h[::-1] for h in tx_hashes]  # <b class="conum">(1)</b>
&gt;&gt;&gt; print(merkle_root(current_level)[::-1].hex())  # <b class="conum">(2)</b>
654d6181e18e4ac4368383fdc5eead11bf138f9b7ac1e15334e4411b3c4797d9</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This reverses each hash before we begin using a <strong>list comprehension</strong></p>
</li>
<li>
<p>This reverses the root at the end</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To make this calculatable for a <code>Block</code>, we have to adjust the class a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:

    def __init__(self, version, prev_block, merkle_root, timestamp, bits, nonce, tx_hashes=None):  # <b class="conum">(1)</b>
        self.version = version
        self.prev_block = prev_block
        self.merkle_root = merkle_root
        self.timestamp = timestamp
        self.bits = bits
        self.nonce = nonce
        self.tx_hashes = tx_hashes</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We now allow the transaction hashes to be set as part of the initialization of the block. The hashes would have to be in order.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As a full node, if we are given all of the transaction hashes, we can now calculate the merkle root and check that the merkle root is what we expect.</p>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Write the <code>validate_merkle_root</code> method for <code>Block</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_merkle_tree">Using a Merkle Tree</h3>
<div class="paragraph">
<p>Now that we know how a Merkle Tree is constructed, we can now utilize it to get a proof-of-inclusion. For nodes that don&#8217;t have the entire blockchain, they can get proofs that certain transactions were included in a block without having to know all the transactions of a block. The essence of how we can do this is the following.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/merkleproof.png" alt="Merkle Proof">
</div>
</div>
<div class="paragraph">
<p>Say that we have two transactions that we are interested in, which would be the hashes marked by green boxes, H<sub>K</sub> and H<sub>N</sub> above. A full node can to prove to us that these transactions were a part of the block by sending us all of the hashes marked by blue boxes, H<sub>ABCDEFGH</sub>, H<sub>IJ</sub>, H<sub>L</sub>, H<sub>M</sub> and H<sub>OP</sub>. We would then perform these calculations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>H<sub>KL</sub> = merkle_parent(H<sub>K</sub>, H<sub>L</sub>)</p>
</li>
<li>
<p>H<sub>MN</sub> = merkle_parent(H<sub>M</sub>, H<sub>N</sub>)</p>
</li>
<li>
<p>H<sub>IJKL</sub> = merkle_parent(H<sub>IJ</sub>, H<sub>KL</sub>)</p>
</li>
<li>
<p>H<sub>MNOP</sub> = merkle_parent(H<sub>MN</sub>, H<sub>OP</sub>)</p>
</li>
<li>
<p>H<sub>IJKLMNOP</sub> = merkle_parent(H<sub>IJKL</sub>, H<sub>MNOP</sub>)</p>
</li>
<li>
<p>H<sub>ABCDEFGHIJKLMNOP</sub> = merkle_parent(H<sub>ABCDEFGH</sub>, H<sub>IJKLMNOP</sub>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The merkle root is H<sub>ABCDEFGHIJKLMNOP</sub>, which we can check against the block header whose proof-of-work we&#8217;ve already validated.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How secure is an SPV proof?</div>
<div class="paragraph">
<p>The full node can send us a limited amount of information about the block and the light node can recalculate the merkle root, which can then be verified against the block header. This does not guarantee that the transaction is in a block, but it does assure the light node that the full node would have had to spend a lot of hashing power and thus energy creating a valid proof-of-work. As long as the reward for creating such aproof-of-work is greater than the amounts in the transactions, the light node can at least know that the full node has no clear economic incentive to lie.</p>
</div>
<div class="paragraph">
<p>Indeed, since the block header can be requested from multiple nodes, light nodes have an easy way to verify if one node is trying to show them block headers that are not the longest. It only takes a single honest node to invalidate 100 dishonest ones since proof-of-work is objective. Therefore, it&#8217;s not easy to isolate a light node enough to be able to deceive in this way. This, of course, assumes that there are lots of nodes on the network in the first place and that a good number of them are being honest.</p>
</div>
<div class="paragraph">
<p>In other words, light client security is based on a robust network of nodes and a little bit of game theory based on econmic incentives. For a transaction up to the block reward, (12.5 BTC as of this writing), there&#8217;s very little to worry about. For large transactions (say 1000 BTC or 80x the mining award), the full nodes, if they&#8217;re controlled by your counterparty, may have economic incentive to deceive you. Transactions that large should generally be done using a full node.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_block">Merkle Block</h3>
<div class="paragraph">
<p>The full node needs to send the information about the tree structure and which hash is at which position in the Merkle Tree. A light node then needs to be able to reconstruct the partial Merkle Tree to actually validate the transaction. The format in which the full node communicates this to the light node is using something called a Merkle Block.</p>
</div>
<div class="paragraph">
<p>To understand what&#8217;s in a Merkle Block, we need to understand a bit about how a Merkle Tree can be traversed. If we look at the diagram above, the nodes can be traversed bredth-first or depth-first. Bredth-first traversal would go level by level like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/bredthfirst.png" alt="Bredth First">
</div>
</div>
<div class="paragraph">
<p>The bredth-first ordering goes wider first and traverses each level before going to the one below.</p>
</div>
<div class="paragraph">
<p>Depth-first ordering is a bit different and looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/depthfirst.png" alt="Depth First">
</div>
</div>
<div class="paragraph">
<p>The depth-first ordering goes deeper first and traverses the left side before the right side.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/merkleproof.png" alt="Merkle Proof">
</div>
</div>
<div class="paragraph">
<p>Going back to this diagram, the full node needs to send us the green boxes, H<sub>K</sub> and H<sub>N</sub> along with the blue boxes H<sub>ABCDEFGH</sub>, H<sub>IJ</sub>, H<sub>L</sub>, H<sub>M</sub> and H<sub>OP</sub>. The full node sends us these items by utilizing depth-first ordering, flags and a list of hashes. We go through each step in detail.</p>
</div>
<div class="sect3">
<h4 id="_merkle_tree_structure">Merkle Tree Structure</h4>
<div class="paragraph">
<p>The first thing we need to do is create the general structure of the Merkle Tree. Because Merkle Trees built from the leaves upward, the only thing we really need is the number of leaves and we&#8217;ll have the structure. The tree above has 16 leaves, which means we can create an empty Merkle Tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; import math
&gt;&gt;&gt; total = 16
&gt;&gt;&gt; max_depth = math.ceil(math.log(total, 2))  # <b class="conum">(1)</b>
&gt;&gt;&gt; merkle_tree = []  # <b class="conum">(2)</b>
&gt;&gt;&gt; for depth in range(max_depth + 1):  # <b class="conum">(3)</b>
...     num_items = math.ceil(total / 2**(max_depth - depth))  # <b class="conum">(4)</b>
...     level_hashes = [None] * num_items  # <b class="conum">(5)</b>
...     merkle_tree.append(level_hashes)  # <b class="conum">(6)</b>
&gt;&gt;&gt; for level in merkle_tree:
...     print(level)
[None]
[None, None]
[None, None, None, None]
[None, None, None, None, None, None, None, None]
[None, None, None, None, None, None, None, None, None, None, None, None, None, None, None, None]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Since we halve at every level, log<sub>2</sub> tells us how many levels there will be to the Merkle Tree. Note we have to round up using <code>math.ceil</code> as we round up for halving at each level. We could also be clever and use <code>len(bin(total))-2</code>.</p>
</li>
<li>
<p>The merkle tree will hold the root at index 0, the level below at index 1 and so on. In other words, the index is the "depth" from the top.</p>
</li>
<li>
<p>We have to go up to <code>max_depth + 1</code> as <code>range</code> goes to 1 less than the second argument in Python.</p>
</li>
<li>
<p>The number of items at any particular level is the number of total leaves divided by the number of times we&#8217;ve halved, rounded up.</p>
</li>
<li>
<p>We don&#8217;t know what any of the hashes are, so we set them to <code>None</code></p>
</li>
<li>
<p>Note again that <code>merkle_tree</code> is a list of lists of hashes.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>Create an empty Merkle Tree with 27 items and print each level.</p>
</div>
</div>
<div class="sect3">
<h4 id="_coding_a_merkle_tree">Coding a Merkle Tree</h4>
<div class="paragraph">
<p>We can now create a <code>MerkleTree</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MerkleTree:
    def __init__(self, total):
        self.total = total
        self.max_depth = math.ceil(math.log(self.total, 2))
        self.nodes = []
        for depth in range(self.max_depth+1):
            num_items = math.ceil(self.total / 2**(self.max_depth - depth))
            level_hashes = [None] * num_items
            self.nodes.append(level_hashes)
        self.current_depth = 0  # <b class="conum">(1)</b>
        self.current_index = 0

    def __repr__(self):  # <b class="conum">(2)</b>
        result = ''
        for depth, level in enumerate(self.nodes):
            for index, h in enumerate(level):
                short = '{}...'.format(h.hex()[:8])
                if depth == self.current_depth and index == self.current_index:
                    result += '*{}*, '.format(short[:-2])
                else:
                    result += '{}, '.format(short)
            result += '\n'
        return result</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We keep a pointer to a particular node in the tree, which will come in handy later.</p>
</li>
<li>
<p>We print a representation of the tree.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Given the leaves, we can use this structure to fill in the rest of the tree. We might be tempted to do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from merkleblock import MerkleTree
&gt;&gt;&gt; from helper import merkle_parent_level
&gt;&gt;&gt; hex_hashes = [...]
&gt;&gt;&gt; tree = MerkleTree(len(hex_hashes))
&gt;&gt;&gt; tree.nodes[4] = [bytes.fromhex(h) for h in hex_hashes]
&gt;&gt;&gt; tree.nodes[3] = merkle_parent_level(tree.nodes[4])
&gt;&gt;&gt; tree.nodes[2] = merkle_parent_level(tree.nodes[3])
&gt;&gt;&gt; tree.nodes[1] = merkle_parent_level(tree.nodes[2])
&gt;&gt;&gt; tree.nodes[0] = merkle_parent_level(tree.nodes[1])
&gt;&gt;&gt; print(tree)
*597c4baf.*,
6382df3f..., 87cf8fa3...,
3ba6c080..., 8e894862..., 7ab01bb6..., 3df760ac...,
272945ec..., 9a38d037..., 4a64abd9..., ec7c95e1..., 3b67006c..., 850683df..., d40d268b..., 8636b7a3...,
9745f717..., 5573c8ed..., 82a02ecb..., 507ccae5..., a7a4aec2..., bb626766..., ea6d7ac1..., 45774386..., 76880292..., b1ae7f15..., 9b74f89f..., b3a92b5b..., b5c0b915..., c9d52c5c..., c555bc5f..., f9dbfafc...,</code></pre>
</div>
</div>
<div class="paragraph">
<p>Indeed, this would fill the tree and allow us to get the root. However, the message from the network may not be giving us all of the leaves. The message might contain some internal nodes as well. We need a more clever way to fill up the tree.</p>
</div>
<div class="paragraph">
<p>Tree traversal is going to be the way we do this. We can do a depth-first traversal and only fill in the nodes that we can calculate. In order to do this, we need to keep track of some state as to where we are in the tree. We purposefully added the <code>self.current_depth</code> and <code>self.current_index</code> as a way to keep track of where in the tree we are.</p>
</div>
<div class="paragraph">
<p>We now need methods to navigate the tree. We&#8217;ll also include some other useful methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MerkleTree:
...
    def up(self):
        self.current_depth -= 1
        self.current_index //= 2

    def left(self):
        self.current_depth += 1
        self.current_index *= 2

    def right(self):
        self.current_depth += 1
        self.current_index = self.current_index * 2 + 1

    def root(self):
        return self.nodes[0][0]

    def set_current_node(self, value):  # <b class="conum">(1)</b>
        self.nodes[self.current_depth][self.current_index] = value

    def get_current_node(self):
        return self.nodes[self.current_depth][self.current_index]

    def get_left_node(self):
        return self.nodes[self.current_depth+1][self.current_index*2]

    def get_right_node(self):
        return self.nodes[self.current_depth+1][self.current_index*2+1]

    def is_leaf(self):  # <b class="conum">(2)</b>
        return self.current_depth == self.max_depth

    def right_exists(self):  # <b class="conum">(3)</b>
        return len(self.nodes[self.current_depth + 1]) &gt; self.current_index * 2 + 1</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We want the ability to set the current node in the tree to some value.</p>
</li>
<li>
<p>We will want to know if we are a leaf node</p>
</li>
<li>
<p>In certain situations, we won&#8217;t have a right child because we&#8217;re the right-most node of a level whose child level has an odd number of items.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can now traverse the tree using the <code>left</code>, <code>right</code> and <code>up</code> methods. Let&#8217;s try populating the tree using depth-first traversal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from merkleblock import MerkleTree
&gt;&gt;&gt; from helper import merkle_parent
&gt;&gt;&gt; hex_hashes = [...]
&gt;&gt;&gt; tree = MerkleTree(len(hex_hashes))
&gt;&gt;&gt; tree.nodes[4] = [bytes.fromhex(h) for h in hex_hashes]
&gt;&gt;&gt; while tree.root() is None:  # <b class="conum">(1)</b>
...     if tree.is_leaf():  # <b class="conum">(2)</b>
...         tree.up()
...     else:
...         left_hash = tree.get_left_node()
...         right_hash = tree.get_right_node()
...         if left_hash is None:  # <b class="conum">(3)</b>
...             tree.left()
...         elif right_hash is None:  # <b class="conum">(4)</b>
...             tree.right()
...         else:  # <b class="conum">(5)</b>
...             tree.set_current_node(merkle_parent(left_hash, right_hash))
...             tree.up()
&gt;&gt;&gt; print(tree)
597c4baf...,
6382df3f..., 87cf8fa3...,
3ba6c080..., 8e894862..., 7ab01bb6..., 3df760ac...,
272945ec..., 9a38d037..., 4a64abd9..., ec7c95e1..., 3b67006c..., 850683df..., d40d268b..., 8636b7a3...,
9745f717..., 5573c8ed..., 82a02ecb..., 507ccae5..., a7a4aec2..., bb626766..., ea6d7ac1..., 45774386..., 76880292..., b1ae7f15..., 9b74f89f..., b3a92b5b..., b5c0b915..., c9d52c5c..., c555bc5f..., f9dbfafc...,</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We are looking to calculate the merkle root. As long as we don&#8217;t have the root, we continue to loop until we do.</p>
</li>
<li>
<p>If we are in a leaf node, we already have that hash, so we don&#8217;t need to do anything but go back up.</p>
</li>
<li>
<p>If we don&#8217;t have the left hash, then we need to calculate that first before we can calculate the current node&#8217;s hash.</p>
</li>
<li>
<p>If we don&#8217;t have the right hash, we need it before calculating the current node&#8217;s hash. Note we should have the left one due to the depth-first traversal.</p>
</li>
<li>
<p>We have both the left and the right hash so we can combine them to get our current node. Once set, we can go upwards.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note this code will only work when the number of leaves is a power of 2.</p>
</div>
<div class="paragraph">
<p>To do something a little more robust and allow for the possibility that the parent might be a combination of the left child twice if it&#8217;s the rightmost node, we have to change things up a bit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from merkleblock import MerkleTree
&gt;&gt;&gt; from helper import merkle_parent_level
&gt;&gt;&gt; hex_hashes = [...]
&gt;&gt;&gt; tree = MerkleTree(len(hex_hashes))
&gt;&gt;&gt; tree.nodes[5] = [bytes.fromhex(h) for h in hex_hashes]
&gt;&gt;&gt; while tree.root() is None:
...     if tree.is_leaf():
...         tree.up()
...     else:
...         left_hash = tree.get_left_node()
...         if left_hash is None:  # <b class="conum">(1)</b>
...             tree.left()
...         elif tree.right_exists():  # <b class="conum">(2)</b>
...             right_hash = tree.get_right_node()
...             if right_hash is None:  # <b class="conum">(3)</b>
...                 tree.right()
...             else:  # <b class="conum">(4)</b>
...                 tree.set_current_node(merkle_parent(left_hash, right_hash))
...                 tree.up()
...         else:  # <b class="conum">(5)</b>
...             tree.set_current_node(merkle_parent(left_hash, left_hash))
...             tree.up()
&gt;&gt;&gt; print(tree)
0a313864...,
597c4baf..., 6f8a8190...,
6382df3f..., 87cf8fa3..., 5647f416...,
3ba6c080..., 8e894862..., 7ab01bb6..., 3df760ac..., 28e93b98...,
272945ec..., 9a38d037..., 4a64abd9..., ec7c95e1..., 3b67006c..., 850683df..., d40d268b..., 8636b7a3..., ce26d40b...,
9745f717..., 5573c8ed..., 82a02ecb..., 507ccae5..., a7a4aec2..., bb626766..., ea6d7ac1..., 45774386..., 76880292..., b1ae7f15..., 9b74f89f..., b3a92b5b..., b5c0b915..., c9d52c5c..., c555bc5f..., f9dbfafc..., 38faf8c8...,</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We start by checking to see if the left hash is defined. If not, we go to the left node since all internal nodes are guaranteed a left child.</p>
</li>
<li>
<p>We check here if this node has a right child. This is true unless this node happens to be the right-most node of the level and the child level has an odd number of nodes.</p>
</li>
<li>
<p>We the see if we have the right hash and if we don&#8217;t, we go and get it.</p>
</li>
<li>
<p>If we have both the left and the right hashes, we combine and go up a level.</p>
</li>
<li>
<p>We are in the situation where we have the left hash, but the right child doesn&#8217;t exist. That means the left hash is combined twice.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We now have code that can traverse the tree for the number of leaves that aren&#8217;t powers of 2.</p>
</div>
</div>
<div class="sect3">
<h4 id="_merkle_block_command">Merkle Block Command</h4>
<div class="paragraph">
<p>The node communicating a Merkle Block needs to send us all the hashes we need to verify that the hash is indeed in the Merkle Tree. Indeed, the merkleblock network command does exactly this. We can see what that looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/merkleblock.png" alt="merkleblock command">
</div>
</div>
<div class="paragraph">
<p>The first 6 fields are exactly the same as the block header from Chapter 9. The other 4 fields are what help us reconstruct the Merkle Root.</p>
</div>
<div class="paragraph">
<p>The number of transactions is how many leaves this particular Merkle Tree will have. This allows us to get the right tree structure. We can create an empty tree and start filling in the hashes. There are a bunch of hashes that are given to us as well as flags that denote where the actual hashes go. The actual flags have to be interpreted a certain way and the <code>bytes_to_bits_field</code> converts the flag bytes to a list of bits (1&#8217;s and 0&#8217;s):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def bytes_to_bit_field(some_bytes):
    flag_bits = []
    # iterate over each byte of flags
    for byte in some_bytes:
        # iterate over each bit, right-to-left
        for _ in range(8):
            # add the current bit (byte &amp; 1)
            flag_bits.append(byte &amp; 1)
            # rightshift the byte 1
            byte &gt;&gt;= 1
    return flag_bits</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ordering for the bytes are a bit strange, but meant to be easy to convert into the bits we need.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Write the parse method for <code>MerkleBlock</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_utilizing_flags_and_hashes">Utilizing Flags and Hashes</h4>
<div class="paragraph">
<p>The flags are a list of bits that tell us about nodes in depth-first order.</p>
</div>
<div class="paragraph">
<p>The rules for the flags are these:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the node is given to us (blue box in the diagram), the flag is 0 and the next hash is the actual hash value.</p>
</li>
<li>
<p>If the node is an internal node and calculated, that is, calculated from its children (dotted outline in the diagram), the flag is 1.</p>
</li>
<li>
<p>If the node is a leaf node and is a transaction we&#8217;re interested in (green box in the diagram), the flag is 1 and the next hash is the actual hash value.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/merkleproof2.png" alt="Merkle Blocks and Hashes">
</div>
</div>
<div class="paragraph">
<p>In this particular case, the flags would be 1 for the root node (1), since that hash is calculated and not given to us. The left child, H<sub>ABCDEFGH</sub> (2), is given to us, so the flag would be 0 and we would have to get the next hash from the list of hashes. From here, we don&#8217;t need to visit H<sub>ABCD</sub> or H<sub>EFGH</sub> since we were already given H<sub>ABCDEFGH</sub>. Thus, we skip all of its descendents and go straight to the right child of the root node.</p>
</div>
<div class="paragraph">
<p>The right child, H<sub>IJKLMNOP</sub> (3) has a flag bit of 1, so is calculated and not given to us. In order to calculate H<sub>IJKLMNOP</sub>, we need to calculate H<sub>IJKL</sub> (4) and H<sub>MNOP</sub> (9). The next item in depth-first order is the left child, H<sub>IJKL</sub> (4), which is what we go to next. This is once again an internal node that&#8217;s calculated, so the flag bit is 1. From here, we need to visit its children H<sub>IJ</sub> (5) and H<sub>KL</sub> (6) to calculate H<sub>IJKL</sub>. The left child, H<sub>IJ</sub> (5) is what we go to first and that&#8217;s a blue box or the hash is being given, so the flag is 0 and we take the next hash from the list of hashes. H<sub>KL</sub> (6) is an internal, calculated node so the flag is 1. H<sub>K</sub> (7) is a leaf node that we&#8217;re interested in so the flag is 1, and the next hash tells us its value. H<sub>L</sub> (8) is a given node so the flag is 0 and the next hash tells us its value. Going next in depth-first order is H<sub>MNOP</sub> (9), which is another internal node so the flag is 1. The left child, H<sub>MN</sub> (10) is another internal node that&#8217;s calculated, so the flag is 1. H<sub>M</sub> (11) is given to us, so we look at the next hash and the flag is 0. H<sub>N</sub> (12) is of interest to us and we get the next hash and the flag is 1. H<sub>OP</sub> (13) is given to us, so we get the final hash from the list.</p>
</div>
<div class="paragraph">
<p>Overall, our flags should be:</p>
</div>
<div class="paragraph">
<p>And we should have been communicated 7 hashes. This is sufficient information to prove that the green boxes, H<sub>K</sub> and H<sub>N</sub> are included in the block with the merkle root from the block header.</p>
</div>
<div class="paragraph">
<p>As you can see in the diagram, the flags apply in depth-first order. Anytime we&#8217;re given a hash, as with H<sub>ABCDEFGH</sub>, we don&#8217;t need to visit any of its children or descendants and go straight to H<sub>IJKLMNOP</sub> instead of H<sub>ABCD</sub>. Flags are a clever mechanism to show us which nodes have which hash.</p>
</div>
<div class="paragraph">
<p>We can now code a way to populate the Merkle Tree and specifically, the root, given appropriate flags and hashes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MerkleTree:
...
    def populate_tree(self, flag_bits, hashes):
        while self.root() is None:  # <b class="conum">(1)</b>
            if self.is_leaf():  # <b class="conum">(2)</b>
                flag_bits.pop(0)  # <b class="conum">(3)</b>
                self.set_current_node(hashes.pop(0))  # <b class="conum">(4)</b>
                self.up()
            else:
                left_hash = self.get_left_node()
                if left_hash is None:  # <b class="conum">(5)</b>
                    if flag_bits.pop(0) == 0:  # <b class="conum">(6)</b>
                        self.set_current_node(hashes.pop(0))
                        self.up()
                    else:
                        self.left()  # <b class="conum">(7)</b>
                elif self.right_exists():  # <b class="conum">(8)</b>
                    right_hash = self.get_right_node()
                    if right_hash is None:  # <b class="conum">(9)</b>
                        self.right()
                    else:  # <b class="conum">(10)</b>
                        self.set_current_node(merkle_parent(left_hash, right_hash))
                        self.up()
                else:  # <b class="conum">(11)</b>
                    self.set_current_node(merkle_parent(left_hash, left_hash))
                    self.up()
        if len(hashes) != 0:  # <b class="conum">(12)</b>
            raise RuntimeError('hashes not all consumed {}'.format(len(hashes)))
        for flag_bit in flag_bits:  # <b class="conum">(13)</b>
            if flag_bit != 0:
                raise RuntimeError('flag bits not all consumed')</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>As before, the point of creating this Merkle Tree is to validate the root. Each loop iteration is looking at one node and we go until the root is calculated.</p>
</li>
<li>
<p>For leaf nodes, we are always given the hash.</p>
</li>
<li>
<p>This is a way in python to dequeue the next item of the list of flags. We might want to keep track of which hashes are being proven to us by looking at the flag, but for now, we don&#8217;t.</p>
</li>
<li>
<p>This is how we get the next item of the list of hashes. We need to set the current node to that hash.</p>
</li>
<li>
<p>In case we don&#8217;t know the left child, we might be either given the hash or have to calculate it.</p>
</li>
<li>
<p>The next flag bit tells us whether we need to calculate this node or not. If the flag is 0, we are given the hash, if the flag is 1, we need to calculate the left (and possibly the right)</p>
</li>
<li>
<p>We are guaranteed that there&#8217;s a left child, so calculate that first.</p>
</li>
<li>
<p>We check that the right node exists. For certain nodes, this may not exist.</p>
</li>
<li>
<p>At this point, we have the left hash, but not the right, in which case we need to calculate the right node&#8217;s hash.</p>
</li>
<li>
<p>We have both the left and the right hash, so we combine them to calculate the current node.</p>
</li>
<li>
<p>We have the rare situation where we have the left hash, but the right does not exist. In this case, according to Merkle Tree rules, we combine the left twice.</p>
</li>
<li>
<p>All hashes must be consumed or we got bad data.</p>
</li>
<li>
<p>All flag bits must be consumed or we got bad data.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7">Exercise 7</h4>
<div class="paragraph">
<p>Write the <code>is_valid</code> method for <code>MerkleBlock</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>It should be obvious at this point why Simplified Payment Verification is useful. However, SPV is not without some significant downsides. The full details are outside the scope of this book, but note that despite the programming being pretty straightforward, most wallets on phones actually do not use SPV, but simply trust nodes from the wallet vendors. The main drawback of SPV is that nodes you are connecting to know something about the transactions you are intersted in. This will be covered more in detail in the next chapter as we make Bloom Filters to tell nodes what transactions we are interested in.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-03-30 09:34:39 -0400
</div>
</div>
</body>
</html>