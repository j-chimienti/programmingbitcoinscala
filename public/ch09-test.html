<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.9">
<title>Programming Bitcoin</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Programming Bitcoin</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_blocks">Blocks</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Transactions essentially transfer bitcoins from one party to another and are authorized by signatures. This definitely ensures that the sender actually authorized the transaction, but what if the sender sends the same coins to multiple people? This is called the double-spending problem and is so called because the owner of a lockbox may try to spend the same output twice. How is the receiver to be assured that they actually received the amount?</p>
</div>
<div class="paragraph">
<p>This is where a major innovation of Bitcoin comes in with Blocks. Think of Blocks as a way to order transactions. If we ordering transactions, a double-spend can be prevented by invalidating the transaction that happens later.</p>
</div>
<div class="paragraph">
<p>Now it would be really nice if we could order transactions one at a time, but that would require everyone to agree on which transaction is supposed to be next and would cause a lot of transmission overhead in coming to consensus. We can also order large batches of transactions, maybe once per day, but that wouldn&#8217;t be very practical as the transactions would settle only once per day.</p>
</div>
<div class="paragraph">
<p>Bitcoin finds a middle ground between these extremes by settling every 10 minutes in batches of transactions. These batches of transactions are what we call blocks. In this chapter we&#8217;ll go through how to parse them and how to check what&#8217;s called the proof of work. We&#8217;ll start with a very special transaction called the Coinbase transaction (not anything to do with the company) which is the first transaction of every block.</p>
</div>
<div class="sect2">
<h3 id="_coinbase_transactions">Coinbase Transactions</h3>
<div class="paragraph">
<p>We start with special transactions called Coinbase transactions. This has nothing to do with the company of the same name based in the US and is the only type of transaction that&#8217;s allowed to bring new coins into existence. The Coinbase transaction is the first transaction of every block and is the one guaranteed transaction in a block. This transaction&#8217;s outputs are kept by the miner and include all the transaction fees of the other transactions in the block.</p>
</div>
<div class="paragraph">
<p>Essentially, the Coinbase transaction is what makes it worthwhile for a miner to mine. Here&#8217;s what a Coinbase transaction looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/coinbase1.png" alt="Coinbase Transaction">
</div>
</div>
<div class="paragraph">
<p>The transaction structure is exactly the same as any other transaction on the Bitcoin network with a few exceptions.</p>
</div>
<div class="paragraph">
<p>First, by rule, Coinbase Transactions must have exactly one input. Second, that input must have a previous transaction of 32 bytes of <code>00</code>. Third, the input must have a previous index of <code>ffffffff</code>.</p>
</div>
<div class="paragraph">
<p>These three determine whether a transaction is a Coinbase transaction or not.</p>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>is_coinbase</code> method of the <code>Tx</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scriptsig">ScriptSig</h4>
<div class="paragraph">
<p>One of the intriguing things about the Coinbase Transaction is that there&#8217;s nothing that the transaction is unlocking as the previous transaction does not exist. So what&#8217;s in there? What information is in there?</p>
</div>
<div class="paragraph">
<p>It turns out that the ScriptSig of the Coinbase transaction is set by miners to be more or less whatever they want. Here is the ScriptSig for the Genesis Block&#8217;s Coinbase Transaction:</p>
</div>
<div class="paragraph">
<p>04ffff001d0104455468652054696d65732030332f4a616e2f32303039204368616e63
656c6c6f72206f6e206272696e6b206f66207365636f6e64206261696c6f757420666f
722062616e6b73</p>
</div>
<div class="paragraph">
<p>This ScriptSig was composed by Satoshi and contains a now-famous message that we can take a look at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from script import Script
&gt;&gt;&gt; s = Script.parse(bytes.fromhex('04ffff...6b73'))
&gt;&gt;&gt; print(s.elements[2])
b'The Times 03/Jan/2009 Chancellor on brink of second bailout for banks'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This was, of course, the headline from The Times newspaper on January 3, 2009.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/genesis.jpg" alt="Genesis Block Coinbase ScriptSig">
</div>
</div>
<div class="paragraph">
<p>This proves that the Genesis Block was created some time <strong>at or after</strong> that date, and not before. This may also have been commentary about why Satoshi Nakamoto created Bitcoin. Regardless, the Coinbase Transaction&#8217;s ScriptSig can contain arbitrary data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bip0034">BIP0034</h4>
<div class="paragraph">
<p>One of the rules for a Coinbase Transaction was added in BIP0034. This was due to a network problem where miners were using the <strong>same</strong> Coinbase Transaction for different blocks. This was possible in the early days as the 32-bit nonce space was enough to mine blocks. The Coinbase being the same means that the transaction id is also the same as the double_sha256 of the transaction is deterministic. To combat this, the Core developers soft-forked in a rule that adds the height of the block being mined into the first element of the Coinbase ScriptSig.</p>
</div>
<div class="paragraph">
<p>The height must be interpreted as a little-endian integer and must equal the height of the block (that is, the number of blocks since the Genesis Block). Here&#8217;s how we can parse the height from the Coinbase Transaction above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from script import Script
&gt;&gt;&gt; from helper import little_endian_to_int
&gt;&gt;&gt; bin_script_sig = bytes.fromhex('03d71b0725...e00')
&gt;&gt;&gt; script_sig = Script.parse(bin_script_sig)
&gt;&gt;&gt; print(little_endian_to_int(script_sig.elements[0]))
465879</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now know which block the transaction was in! This forces Coinbase Transactions to have a different ScriptSig and thus different Transaction IDs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>coinbase_height</code> method for the <code>Tx</code> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_headers_vs_full_blocks">Headers vs Full Blocks</h3>
<div class="paragraph">
<p>Blocks are batches of transactions and the block header is metadata about the transactions included in the block. The block header consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Version</p>
</li>
<li>
<p>Previous Block</p>
</li>
<li>
<p>Merkle Root</p>
</li>
<li>
<p>Timestamp</p>
</li>
<li>
<p>Bits</p>
</li>
<li>
<p>Nonce</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/block1.png" alt="Block Parsing">
</div>
</div>
<div class="paragraph">
<p>This is the metadata for every block. Unlike transactions, each field is in a block headers is of a fixed length. Version is 4 bytes, Previous Block is 32 bytes, Merkle Root is 32 bytes, Timestamp is 4 bytes, Bits is 4 bytes and Nonce is 4 bytes. The headers therefore, take up exactly 80 bytes for each block. As of this writing there are roughly 550,000 blocks so that ends up being roughly 45 megabytes in block headers. The entire blockchain, on the other hand, is roughly 150 GB, so the headers are roughly .027% of the size. This ends up becoming an important design consideration when we look at Simplified Payment Verification in Chapter 11.</p>
</div>
<div class="paragraph">
<p>The id of the block is once again the double_sha256 of its contents. When you find the double_sha256 of this block, you&#8217;ll start to notice something interesting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import double_sha256
&gt;&gt;&gt; block_id = double_sha256(bytes.fromhex('02000020...a4ffd71d'))
&gt;&gt;&gt; print(block_id.hex())
2375044d646ad73594dd0b37b113becdb03964584c9e7e000000000000000000</code></pre>
</div>
</div>
<div class="paragraph">
<p>This id is what gets put into prev_block for a block building on top of this one. For now, notice that the id has a lot of 0&#8217;s at the end. We&#8217;ll come back to this in the proof-of-work section below.</p>
</div>
<div class="paragraph">
<p>We can start coding a <code>Block</code> class based on what we already know:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:

    def __init__(self, version, prev_block, merkle_root, timestamp, bits, nonce):
        self.version = version
        self.prev_block = prev_block
        self.merkle_root = merkle_root
        self.timestamp = timestamp
        self.bits = bits
        self.nonce = nonce</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the parse, serialize and hash methods for block.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_version">Version</h3>
<div class="paragraph">
<p>Version in normal software refers to a particular set of features. For a block, this is similar, in the sense that the version field reflects what capabilities the software that produced the block is ready for. In the past this was used as a way to indicate a single feature that was ready. Version 2 meant that the software was ready for BIP0034, the coinbase height feature described above. Version 3 meant that the software was ready for BIP0066, the enforcement of strict DER encoding. Version 4 meant that the software was ready for BIP0065, which specified OP_CHECKLOCKTIMEVERIFY.</p>
</div>
<div class="paragraph">
<p>Unfortunately, this incremental increase in version number means that only one feature may be signaled on the network at a time. To alleviate this, the developers came up with BIP9, which allows up to 29 different features to be signaled at the same time.</p>
</div>
<div class="sect3">
<h4 id="_bip9">BIP9</h4>
<div class="paragraph">
<p>The way BIP9 works is by fixing the first 3 bits of the 4-byte (32-bit) header to be 001 to indicate that the miner is utilizing BIP9. This means that in hexadecimal, the first character will always be 2 or 3. The other 29 bits can be assigned to different soft-fork features which miners can signal readiness for. For example, bit 0 (the rightmost bit) can be flipped to 1 to signal readiness for one soft fork, bit 1 (the second bit from the right) can be flipped to 1 to signal readiness for another, bit 2 (the third bit from the right) can be flipped to 1 to signal readiness for another and so on.</p>
</div>
<div class="paragraph">
<p>BIP9 requires that 95% of miners signal readiness in a given 2016 block period before the soft fork feature gets activated on the network. As of this writing far, the only soft forks to utilize BIP9 have been BIP141 (segwit) and BIP91 (reducing threshold for segwit). They were assigned bits 1 and 4 respectively.</p>
</div>
<div class="paragraph">
<p>Checking for these features is relatively straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from block import Block
&gt;&gt;&gt; b = Block.parse(BytesIO(bytes.fromhex('0200...')))
&gt;&gt;&gt; print('BIP9: {}'.format(b.version &lt;&lt; 29 == 0b001))  # <b class="conum">(1)</b>
True
&gt;&gt;&gt; print('BIP91: {}'.format(b.version &lt;&lt; 4 &amp; 1 == 1))  # <b class="conum">(2)</b>
False
&gt;&gt;&gt; print('BIP141: {}'.format(b.version &lt;&lt; 1 &amp; 1 == 1))  # <b class="conum">(3)</b>
True</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>&lt;&lt;</code> operator is the left bit-shift operator, which essentially throws away the rightmost 29 bits, leaving just the top 3 bits. The <code>0b001</code> is a way of writing a number in binary format in Python.</p>
</li>
<li>
<p>The <code>&amp;</code> operator is the "bitwise and" operator. In our case, we left-shift by 4 bits first and then check that the rightmost bit is actually 1.</p>
</li>
<li>
<p>We shift 1 to the left because BIP141 was assigned to bit 1.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Write the <code>bip9</code>, <code>bip91</code> and <code>bip141</code> methods for the <code>Block</code> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_previous_block">Previous Block</h3>
<div class="paragraph">
<p>All blocks have to point to a previous block. This is why the data structure is called a <strong>blockchain</strong>. Blocks link back all the way to what we call the Genesis Block. We will note here that the block id actually ends in a bunch of 0&#8217;s, which we discuss more during the proof-of-work section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_merkle_root">Merkle Root</h3>
<div class="paragraph">
<p>The Merkle Root encodes all the ordered transactions in a nice 32 byte hash. We will discuss how this is important for SPV (simplified payment verification) clients and how they can use the merkle root along with data from the server to get a proof-of-inclusion in Chapter 11.</p>
</div>
</div>
<div class="sect2">
<h3 id="_timestamp">Timestamp</h3>
<div class="paragraph">
<p>The timestamp is a unix-style timestamp taking up 4 bytes. Unix timestamps simply encode the number of seconds since January 1, 1970. This timestamp is used in two places. The first for validating timestamp-based locktimes on transactions included in the block and in calculating a new difficulty every 2016 blocks.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Is Bitcoin going to overflow on the timestamp?</div>
<div class="paragraph">
<p>Bitcoin&#8217;s timestamp field in the block header is 32 bits. This means that once the unix timestamp exceeds 2<sup>32</sup>-1, we will go back to 0. 2<sup>32</sup> seconds is roughly 136 years, which means that this field will go back to 0 in 2106 (136 years after 1970).</p>
</div>
<div class="paragraph">
<p>Many people mistakenly believe that we only have until 68 years after 1970, or 2038, but that&#8217;s only when the field is a signed integer (2<sup>31</sup> seconds is 68 years), so we get the benefit of that extra bit, giving us until 2106.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bits">Bits</h3>
<div class="paragraph">
<p>Bits is a field that encodes the amount of work necessary in this block. This will be discussed more in the proof-of-work section below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nonce">Nonce</h3>
<div class="paragraph">
<p>Nonce stands for "number used only once" or n-once. This number is what is changed by miners when looking for proof-of-work.</p>
</div>
</div>
<div class="sect2">
<h3 id="_proof_of_work">Proof of Work</h3>
<div class="paragraph">
<p>Proof of work is what secures Bitcoin and at a deep level, makes Bitcoin decentralized. Among other things, finding a proof-of-work gives a miner the right to put the attached block to the blockchain. As proof-of-work is very rare, this is not an easy task. But because proof-of-work is objective and easy to verify anyone can be a miner if they so choose.</p>
</div>
<div class="paragraph">
<p>Proof-of-work is called "mining" for a very good reason. Like physical mining, there is something that miners are searching for. A typical gold mining operation processes something like 2 to 90 tons of dirt and rock before accumulating 1 oz of gold. This is because gold is very rare. However, once gold is found, it&#8217;s very easy to verify that the gold is actually gold. There are chemical tests, touchstones and many other ways to tell relatively cheaply whether the thing found is gold.</p>
</div>
<div class="paragraph">
<p>Similarly, proof-of-work is actually a very rare number. To find a proof-of-work, the miners on the Bitcoin network have to churn through the numerical equivalent of dirt and rock to find that proof-of-work. Like gold, verifying proof-of-work is much cheaper than actually finding it.</p>
</div>
<div class="paragraph">
<p>So what is the actual proof-of-work? To it&#8217;s easiest to look at the double_sha256 of the block we looked at above:</p>
</div>
<div class="paragraph">
<p><code>020000208ec39428b17323fa0ddec8e887b4a7c53b8c0a0a220cfd000000000000000000
5b0750fce0a889502d40508d39576821155e9c9e3f5c3157f961db38fd8b25be1e77a759
e93c0118a4ffd71d</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import double_sha256
&gt;&gt;&gt; block_id = double_sha256(bytes.fromhex('02000020...a4ffd71d'))[::-1]
&gt;&gt;&gt; print('{}'.format(block_id.hex()).zfill(64))  # <b class="conum">(1)</b>
0000000000000000007e9e4c586439b0cdbe13b1370bdd9435d76a644d047523</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We are purposefully printing this number as 64 hexadecimal digits to show how small it is in 256-bit terms.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can calculate the probability of any random 256-bit number being this small. The probability of the first bit in a 256-bit number being 0 is 0.5. The first two bits being 00, 0.25. The first three bits being 000, 0.125 and so on. Note that each 0 in the hexadecimal above represents 4 0-bits. In this case, we have the first 73 bits being 0, which is 0.5<sup>73</sup> or about 1 in 10<sup>22</sup>. This is a really tiny probability. You have to look at on average 10<sup>22</sup> or 10 sextillion random numbers before you find one this small.</p>
</div>
<div class="paragraph">
<p>Hash functions like double_sha256 have the property that the result is more or less random. Since we used double_sha256 as the hash function to get the block hash, another way to look at this number is to say that we need to calculate 10<sup>22</sup> hashes to find one this small. In other words, the process of finding proof-of-work requires us to process around 10<sup>22</sup> numerical equivalents to dirt and rock to find our numerical equivalent of a gold nugget.</p>
</div>
<div class="sect3">
<h4 id="_how_a_miner_can_generate_new_hashes">How a miner can generate new hashes</h4>
<div class="paragraph">
<p>So where does the miner get new numerical dirt to process to see if it satisfies proof-of-work? This is where the nonce field comes in. The miners can change the nonce field at will.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the 4 bytes or 32-bits, or 2<sup>32</sup> possible nonces that a miner can try is insufficient space. This is because modern ASIC equipment can calculate way more than 2<sup>32</sup> different hashes per second. The AntMiner S9, for example, calculates 12 Th/s, or 12,000,000,000,000 hashes per second. That is approximately 2<sup>43</sup> hashes per second which means that the nonce space can be consumed in just 0.0003 seconds.</p>
</div>
<div class="paragraph">
<p>What miners can then do is to change the Coinbase transaction, which then changes the merkle root, giving miners a fresh nonce space each time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_target">Target</h4>
<div class="paragraph">
<p>Proof-of-work is the requirement that every block in Bitcoin must be below a certain <strong>target</strong>. Target is a small 256-bit number that is computed directly from the bits field.</p>
</div>
<div class="paragraph">
<p><code>e93c0118</code></p>
</div>
<div class="paragraph">
<p>The bits field is actually two different numbers. The first is the exponent, which is the last byte. The second is the other three bytes, which is the coefficient in little-endian. The formula for calculating the target from these two numbers is:</p>
</div>
<div class="paragraph">
<p>target = coefficient * 256<sup>exponent-3</sup></p>
</div>
<div class="paragraph">
<p>We can now calculate this given a bits field in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import little_endian_to_int
&gt;&gt;&gt; bits = bytes.fromhex('e93c0118')
&gt;&gt;&gt; exponent = bits[-1]
&gt;&gt;&gt; coefficient = little_endian_to_int(bits[:-1])
&gt;&gt;&gt; target = coefficient * 256 **(exponent-3)
&gt;&gt;&gt; print('{:x}'.format(target).zfill(64))  # <b class="conum">(1)</b>
0000000000000000013ce9000000000000000000000000000000000000000000</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We are purposefully printing this number as 64 hexadecimal digits to show how small it is in 256-bit terms.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A valid proof of work is a hash of the block which, when interpreted as a little-endian integer is below the target number. Proof of work hashes are exceedingly rare and the process of mining is essentially the process of finding one of these hashes. To find a single proof-of-work with the above target, the network as a whole must calculate 3.8 * 10<sup>21</sup> hashes. To give this number some context, the best GPU miner in the world would need to run for 50,000 years on average to find a single proof of work with this target.</p>
</div>
<div class="paragraph">
<p>We can check that this block&#8217;s hash is indeed below the target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import little_endian_to_int
&gt;&gt;&gt; proof = little_endian_to_int(double_sha256(bytes.fromhex('02000020...a4ffd71d')))
&gt;&gt;&gt; print(proof &lt; target)  # <b class="conum">(1)</b>
True</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>target</code> is calculated above.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can actually see that the proof of work is lower by lining up the numbers in 64 hex characters:</p>
</div>
<div class="paragraph">
<p><code>0000000000000000013ce9000000000000000000000000000000000000000000</code>   # target</p>
</div>
<div class="paragraph">
<p><code>0000000000000000007e9e4c586439b0cdbe13b1370bdd9435d76a644d047523</code>   # proof of work</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>Write the target method for the Block class.</p>
</div>
</div>
<div class="sect3">
<h4 id="_difficulty">Difficulty</h4>
<div class="paragraph">
<p>Target is difficult to work with for human beings. We know that this is the number that the hash must be below, but as humans, it&#8217;s hard to fathom the difference between a 180-bit number and a 190-bit number. The first is a thousand times smaller, but from looking at targets, such large numbers are not easy to contextualize.</p>
</div>
<div class="paragraph">
<p>To make different targets easier to compare, the concept of difficulty was born. Essentialy, difficulty is inversely proportional to target to make comparisons easier. The specific formula is:</p>
</div>
<div class="paragraph">
<p>difficulty = 0xffff * 256<sup>0x1d-3</sup> / target</p>
</div>
<div class="paragraph">
<p>We can code this in python like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import little_endian_to_int
&gt;&gt;&gt; bits = bytes.fromhex('e93c0118')
&gt;&gt;&gt; exponent = bits[-1]
&gt;&gt;&gt; coefficient = little_endian_to_int(bits[:-1])
&gt;&gt;&gt; target = coefficient*256**(exponent-3)
&gt;&gt;&gt; difficulty = 0xffff * 256**(0x1d-3) / target
&gt;&gt;&gt; print(difficulty)
888171856257.3206</code></pre>
</div>
</div>
<div class="paragraph">
<p>The difficulty on testnet when there haven&#8217;t been any blocks found in 20 minutes resets to 1. This gives us context for how difficult mainnet is. The difficulty number can be thought of as how much more difficult mainnet is than testnet&#8217;s easiest difficulty. This difficulty is roughly 888 billion times more difficult than testnet at its easiest setting.</p>
</div>
<div class="paragraph">
<p>This is the number that gets shown in block explorers and bitcoin price charting services as difficulty is a much more intuitive way to understand what&#8217;s going on in terms of effort required to create a new block.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Write the difficulty method for the Block class</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_the_proof_of_work_is_sufficient">Checking that the Proof-of-Work is sufficient</h4>
<div class="paragraph">
<p>We already learned that proof-of-work can be calculated by computing the double-sha256 of the block header and interpreting this as a little-endian integer. If this number is lower than the target, we have a valid proof-of-work. If not, the block is not valid as it doesn&#8217;t have proof-of-work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7">Exercise 7</h4>
<div class="paragraph">
<p>Write the check_pow method for the Block class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_difficulty_adjustment">Difficulty Adjustment</h3>
<div class="paragraph">
<p>In Bitcoin, each group of 2016 blocks is called a <em>difficulty adjustment period</em>. At the end of every difficulty adjustment period, the target is adjusted according to this formula:</p>
</div>
<div class="paragraph">
<p>time_differential = block timestamp of last block in difficulty adjustment period - block timestamp of first block in difficulty adjustment period</p>
</div>
<div class="paragraph">
<p>new_target = previous_target * time_differential / (2 weeks)</p>
</div>
<div class="paragraph">
<p>The time_differential number is calculated so that if it&#8217;s greater than 8 weeks, 8 weeks is used and if it&#8217;s less than 3.5 days, 3.5 days is used. This way, the new target cannot change more than 4x in either direction. That is, the target will be reduced or increased by 4x at the most.</p>
</div>
<div class="paragraph">
<p>If each block took on average 10 minutes, 2016 blocks should take 20160 minutes. There are 1440 minutes per day, which means that 2016 blocks take 20160 / 1440 = 14 days. We should be calculating how long the last 2016 blocks took by using the timestamp field of the block at the very end of each of the current and previous difficulty adjustment periods. Satoshi unfortunately had another off-by-one error here, as the timestamp differential calculation looks at the very first and very last blocks of the 2016 block difficulty adjustment period instead. This means that the time_differential ends up being the difference of blocks that are 2015 blocks apart instead of 2016 blocks apart.</p>
</div>
<div class="paragraph">
<p>We can code this formula like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from block import Block
&gt;&gt;&gt; last_block = Block.parse(BytesIO(bytes.fromhex('00...f5')))
&gt;&gt;&gt; first_block = Block.parse(BytesIO(bytes.fromhex('00...2e')))
&gt;&gt;&gt; time_differential = last_block.timestamp - first_block.timestamp
&gt;&gt;&gt; if time_differential &gt; 60 * 60 * 24 * 14 * 4:  # <b class="conum">(1)</b>
...     time_differential = 60 * 60 * 24 * 14 * 4
&gt;&gt;&gt; if time_differential &lt; 60 * 60 * 24 * 14 // 4:  # <b class="conum">(2)</b>
...     time_differential = 60 * 60 * 24 * 14 // 4
&gt;&gt;&gt; new_target = last_block.target() * time_differential // (60 * 60 * 24 * 14)
&gt;&gt;&gt; print('{:x}'.format(new_target).zfill(64))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Note that <code>60*60*24*14</code> is the number of seconds in 2 weeks. 60 seconds times 60 minutes times 24 hours times 14 days. This makes sure that if it took more than 8 weeks to find the last 2015 blocks, we don&#8217;t decrease the difficulty too much.</p>
</li>
<li>
<p>This part makes sure that if it took less than 3.5 days to find the last 2015 blocks, we don&#8217;t increase the difficulty too much.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The nice thing about this formula is that you only need the headers to calculate what the next block target should be. Once we have the target, we then convert this to bits. The inverse operation looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def target_to_bits(target):
    raw_bytes = target.to_bytes(32, 'big')
    raw_bytes = raw_bytes.lstrip(b'\x00')  # <b class="conum">(1)</b>
    if raw_bytes[0] &gt; 0x7f:  # <b class="conum">(2)</b>
        exponent = len(raw_bytes) + 1
        coefficient = b'\x00' + raw_bytes[:2]
    else:
        exponent = len(raw_bytes)  # <b class="conum">(3)</b>
        coefficient = raw_bytes[:3]  # <b class="conum">(4)</b>
    new_bits_big_endian = bytes([exponent]) + coefficient
    return new_bits_big_endian[::-1]  # <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get rid of all the leading 0&#8217;s.</p>
</li>
<li>
<p>The bits format is really a way to express really large numbers, both negative and positive. If the first bit in the coefficient is a 1, this is supposed to be interpreted as a negative number. Since target is always positive for us, we shift everything over by 1 byte if the first bit is 1.</p>
</li>
<li>
<p>The exponent is really just how long the number is in base-256.</p>
</li>
<li>
<p>The coefficient is the first 3 digits of the base-256 number.</p>
</li>
<li>
<p>We end up truncating the number after the first 3 digits of the base-256 number in case the first bit is 0, the after the first 2 digits if the first it is 1.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the block doesn&#8217;t have the correct bits, then we can safely reject that block.</p>
</div>
<div class="sect3">
<h4 id="_exercise_8">Exercise 8</h4>
<div class="paragraph">
<p>Calculate the new bits given the first and last blocks of this 2016 block difficulty adjustment period:</p>
</div>
<div class="paragraph">
<p>Block 471744: 000000203471101bbda3fe307664b3283a9ef0e97d9a38a7eacd8800000000000000000010c8aba8479bbaa5e0848152fd3c2289ca50e1c3e58c9a4faaafbdf5803c5448ddb845597e8b0118e43a81d3</p>
</div>
<div class="paragraph">
<p>Block 473759: 02000020f1472d9db4b563c35f97c428ac903f23b7fc055d1cfc26000000000000000000b3f449fcbe1bc4cfbcb8283a0d2c037f961a3fdf2b8bedc144973735eea707e1264258597e8b0118e5f00474</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_9">Exercise 9</h4>
<div class="paragraph">
<p>Write the calculate_new_bits function.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>We&#8217;ve learned how to calculate proof of work, how to calculate the difficulty adjustment for a block in addition to learning about Coinbase Transactions. We&#8217;ll now move onto the one field we haven&#8217;t really covered, which is the merkle root in the next chapter.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-03-30 09:34:39 -0400
</div>
</div>
</body>
</html>