<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.9">
<title>Solutions</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="appendix_solutions">Appendix A: Solutions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_chapter_finite_fields_finite_fields"><a href="#chapter_finite_fields">[chapter_finite_fields]</a>: Finite Fields</h3>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Write the corresponding method <code><em>ne</em></code>, which checks if two <code>FieldElement</code> objects are <em>not equal</em> to each other.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class FieldElement:
...
    def __ne__(self, other):
        # this should be the inverse of the == operator
        return not (self == other)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Solve these problems in <em>F</em><sub>57</sub> (assume all +'s here are +<sub><em>f</em></sub> and –'s here are –<sub><em>f</em></sub>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>44 + 33</p>
</li>
<li>
<p>9 – 29</p>
</li>
<li>
<p>17 + 42 + 49</p>
</li>
<li>
<p>52 – 30 – 38</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; prime = 57
&gt;&gt;&gt; print((44+33)%prime)
20
&gt;&gt;&gt; print((9-29)%prime)
37
&gt;&gt;&gt; print((17+42+49)%prime)
51
&gt;&gt;&gt; print((52-30-38)%prime)
41</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the corresponding <code><em>sub</em></code> method that defines the subtraction of two <span class="keep-together"><code>FieldElement</code></span> objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class FieldElement:
...
    def __sub__(self, other):
        if self.prime != other.prime:
            raise TypeError('Cannot subtract two numbers in different Fields')
        # self.num and other.num are the actual values
        # self.prime is what we need to mod against
        num = (self.num - other.num) % self.prime
        # we return an element of the same class
        return self.__class__(num, self.prime)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Solve the following equations in <em>F</em><sub>97</sub> (again, assume ⋅ and exponentiation are field <span class="keep-together">versions</span>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>95 ⋅ 45 ⋅ 31</p>
</li>
<li>
<p>17 ⋅ 13 ⋅ 19 ⋅ 44</p>
</li>
<li>
<p>12<sup>7</sup> ⋅ 77<sup>49</sup></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; prime = 97
&gt;&gt;&gt; print(95*45*31 % prime)
23
&gt;&gt;&gt; print(17*13*19*44 % prime)
68
&gt;&gt;&gt; print(12**7*77**49 % prime)
63</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>For <em>k</em> = 1, 3, 7, 13, 18, what is this set in <em>F</em><sub>19</sub>?</p>
</div>
<ul class="simplelist">
<li>{<em>k</em> ⋅ 0, <em>k</em> ⋅ 1, <em>k</em> ⋅ 2, <em>k</em> ⋅ 3, ... <em>k</em> ⋅ 18}</li>
</ul>
<div class="paragraph">
<p>Do you notice anything about these sets?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; prime = 19
&gt;&gt;&gt; for k in (1,3,7,13,18):
...     print([k*i % prime for i in range(prime)])
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
[0, 3, 6, 9, 12, 15, 18, 2, 5, 8, 11, 14, 17, 1, 4, 7, 10, 13, 16]
[0, 7, 14, 2, 9, 16, 4, 11, 18, 6, 13, 1, 8, 15, 3, 10, 17, 5, 12]
[0, 13, 7, 1, 14, 8, 2, 15, 9, 3, 16, 10, 4, 17, 11, 5, 18, 12, 6]
[0, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
&gt;&gt;&gt; for k in (1,3,7,13,18):
...     print(sorted([k*i % prime for i in range(prime)]))
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When sorted, the results are always the same set.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Write the corresponding <code><em>mul</em></code> method that defines the multiplication of two finite field elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class FieldElement:
...
    def __mul__(self, other):
        if self.prime != other.prime:
            raise TypeError('Cannot multiply two numbers in different Fields')
        # self.num and other.num are the actual values
        # self.prime is what we need to mod against
        num = (self.num * other.num) % self.prime
        # we return an element of the same class
        return self.__class__(num, self.prime)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7">Exercise 7</h4>
<div class="paragraph">
<p>For <em>p</em> = 7, 11, 17, 31, what is this set in <em>F<sub>p</sub></em>?</p>
</div>
<ul class="simplelist">
<li>{1<sup>(<em>p</em> – 1)</sup>, 2<sup>(<em>p</em> – 1)</sup>, 3<sup>(<em>p</em> – 1)</sup>, 4<sup>(<em>p</em> – 1)</sup>, ... (<em>p</em> – 1)<sup>(<em>p</em> – 1)</sup>}</li>
</ul>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; for prime in (7, 11, 17, 31):
...     print([pow(i, prime-1, prime) for i in range(1, prime)])
[1, 1, 1, 1, 1, 1]
[1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, \
1, 1, 1, 1, 1, 1]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_8">Exercise 8</h4>
<div class="paragraph">
<p>Solve the following equations in <em>F</em><sub>31</sub>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3 / 24</p>
</li>
<li>
<p>17<sup>–3</sup></p>
</li>
<li>
<p>4<sup>–4</sup> ⋅ 11</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; prime = 31
&gt;&gt;&gt; print(3*pow(24, prime-2, prime) % prime)
4
&gt;&gt;&gt; print(pow(17, prime-4, prime))
29
&gt;&gt;&gt; print(pow(4, prime-5, prime)*11 % prime)
13</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_9">Exercise 9</h4>
<div class="paragraph">
<p>Write the corresponding <code><em>truediv</em></code> method that defines the division of two field elements.</p>
</div>
<div class="paragraph">
<p>Note that in Python 3, division is separated into <code><em>truediv</em></code> and <code><em>floordiv</em></code>. The first does normal division and the second does integer division.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class FieldElement:
...
    def __truediv__(self, other):
        if self.prime != other.prime:
            raise TypeError('Cannot divide two numbers in different Fields')
        # use Fermat's little theorem:
        # self.num**(p-1) % p == 1
        # this means:
        # 1/n == pow(n, p-2, p)
        # we return an element of the same class
        num = self.num * pow(other.num, self.prime - 2, self.prime) % self.prime
        return self.__class__(num, self.prime)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_elliptic_curves_elliptic_curves"><a href="#chapter_elliptic_curves">[chapter_elliptic_curves]</a>: Elliptic Curves</h3>
<div class="sect3">
<h4 id="_exercise_1_2">Exercise 1</h4>
<div class="paragraph">
<p>Determine which of these points are on the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 5<em>x</em> + 7:</p>
</div>
<ul class="simplelist">
<li>(2,4), (–1,–1), (18,77), (5,7)</li>
</ul>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; def on_curve(x, y):
...     return y**2 == x**3 + 5*x + 7
&gt;&gt;&gt; print(on_curve(2,4))
False
&gt;&gt;&gt; print(on_curve(-1,-1))
True
&gt;&gt;&gt; print(on_curve(18,77))
True
&gt;&gt;&gt; print(on_curve(5,7))
False</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_2">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code><em>ne</em></code> method for <code>Point</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Point:
...
    def __ne__(self, other):
        return not (self == other)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_2">Exercise 3</h4>
<div class="paragraph">
<p>Handle the case where the two points are additive inverses (that is, they have the same <code>x</code> but a different <code>y</code>, causing a vertical line). This should return the point at infinity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Point:
...
    if self.x == other.x and self.y != other.y:
        return self.__class__(None, None, self.a, self.b)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_2">Exercise 4</h4>
<div class="paragraph">
<p>For the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 5<em>x</em> + 7, what is (2,5) + (–1,–1)?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; x1, y1 = 2, 5
&gt;&gt;&gt; x2, y2 = -1, -1
&gt;&gt;&gt; s = (y2 - y1) / (x2 - x1)
&gt;&gt;&gt; x3 = s**2 - x1 - x2
&gt;&gt;&gt; y3 = s * (x1 - x3) - y1
&gt;&gt;&gt; print(x3, y3)
3.0 -7.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_2">Exercise 5</h4>
<div class="paragraph">
<p>Write the <code><em>add</em></code> method where <em>x</em><sub>1</sub> ≠ <em>x</em><sub>2</sub>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Point:
...
    def __add__(self, other):
    ...
    if self.x != other.x:
        s = (other.y - self.y) / (other.x - self.x)
        x = s**2 - self.x - other.x
        y = s * (self.x - x) - self.y
        return self.__class__(x, y, self.a, self.b)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_2">Exercise 6</h4>
<div class="paragraph">
<p>For the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 5<em>x</em> + 7, what is (–1,–1) + (–1,–1)?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; a, x1, y1 = 5, -1, -1
&gt;&gt;&gt; s = (3 * x1**2 + a) / (2 * y1)
&gt;&gt;&gt; x3 = s**2 - 2*x1
&gt;&gt;&gt; y3 = s*(x1-x3)-y1
&gt;&gt;&gt; print(x3,y3)
18.0 77.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7_2">Exercise 7</h4>
<div class="paragraph">
<p>Write the <code><em>add</em></code> method when <em>P</em><sub>1</sub> = <em>P</em><sub>2</sub>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Point:
...
    def __add__(self, other):
    ...
    if self == other:
        s = (3 * self.x**2 + self.a) / (2 * self.y)
        x = s**2 - 2 * self.x
        y = s * (self.x - x) - self.y
        return self.__class__(x, y, self.a, self.b)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_elliptic_curve_cryptography_elliptic_curve_cryptography"><a href="#chapter_elliptic_curve_cryptography">[chapter_elliptic_curve_cryptography]</a>: Elliptic Curve Cryptography</h3>
<div class="sect3">
<h4 id="_exercise_1_3">Exercise 1</h4>
<div class="paragraph">
<p>Evaluate whether these points are on the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 7 over <em>F</em><sub>223</sub>:</p>
</div>
<ul class="simplelist">
<li>(192,105), (17,56), (200,119), (1,193), (42,99)</li>
</ul>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import FieldElement
&gt;&gt;&gt; prime = 223
&gt;&gt;&gt; a = FieldElement(0, prime)
&gt;&gt;&gt; b = FieldElement(7, prime)
&gt;&gt;&gt; def on_curve(x,y):
...     return y**2 == x**3 + a*x + b
&gt;&gt;&gt; print(on_curve(FieldElement(192, prime), FieldElement(105, prime)))
True
&gt;&gt;&gt; print(on_curve(FieldElement(17, prime), FieldElement(56, prime)))
True
&gt;&gt;&gt; print(on_curve(FieldElement(200, prime), FieldElement(119, prime)))
False
&gt;&gt;&gt; print(on_curve(FieldElement(1, prime), FieldElement(193, prime)))
True
&gt;&gt;&gt; print(on_curve(FieldElement(42, prime), FieldElement(99, prime)))
False</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_3">Exercise 2</h4>
<div class="paragraph">
<p>For the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 7 over <em>F</em><sub>223</sub>, find:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(170,142) + (60,139)</p>
</li>
<li>
<p>(47,71) + (17,56)</p>
</li>
<li>
<p>(143,98) + (76,66)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import FieldElement, Point
&gt;&gt;&gt; prime = 223
&gt;&gt;&gt; a = FieldElement(0, prime)
&gt;&gt;&gt; b = FieldElement(7, prime)
&gt;&gt;&gt; p1 = Point(FieldElement(170, prime), FieldElement(142, prime), a, b)
&gt;&gt;&gt; p2 = Point(FieldElement(60, prime), FieldElement(139, prime), a, b)
&gt;&gt;&gt; print(p1+p2)
Point(220,181)_0_7 FieldElement(223)
&gt;&gt;&gt; p1 = Point(FieldElement(47, prime), FieldElement(71, prime), a, b)
&gt;&gt;&gt; p2 = Point(FieldElement(17, prime), FieldElement(56, prime), a, b)
&gt;&gt;&gt; print(p1+p2)
Point(215,68)_0_7 FieldElement(223)
&gt;&gt;&gt; p1 = Point(FieldElement(143, prime), FieldElement(98, prime), a, b)
&gt;&gt;&gt; p2 = Point(FieldElement(76, prime), FieldElement(66, prime), a, b)
&gt;&gt;&gt; print(p1+p2)
Point(47,71)_0_7 FieldElement(223)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_3">Exercise 3</h4>
<div class="paragraph">
<p>Extend <code>ECCTest</code> to test for the additions from the previous exercise. Call this <code>test_add</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def test_add(self):
    prime = 223
    a = FieldElement(0, prime)
    b = FieldElement(7, prime)
    additions = (
        (192, 105, 17, 56, 170, 142),
        (47, 71, 117, 141, 60, 139),
        (143, 98, 76, 66, 47, 71),
    )
    for x1_raw, y1_raw, x2_raw, y2_raw, x3_raw, y3_raw in additions:
        x1 = FieldElement(x1_raw, prime)
        y1 = FieldElement(y1_raw, prime)
        p1 = Point(x1, y1, a, b)
        x2 = FieldElement(x2_raw, prime)
        y2 = FieldElement(y2_raw, prime)
        p2 = Point(x2, y2, a, b)
        x3 = FieldElement(x3_raw, prime)
        y3 = FieldElement(y3_raw, prime)
        p3 = Point(x3, y3, a, b)
        self.assertEqual(p1 + p2, p3)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_3">Exercise 4</h4>
<div class="paragraph">
<p>For the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 7 over <em>F</em><sub>223</sub>, find:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>2 ⋅ (192,105)</p>
</li>
<li>
<p>2 ⋅ (143,98)</p>
</li>
<li>
<p>2 ⋅ (47,71)</p>
</li>
<li>
<p>4 ⋅ (47,71)</p>
</li>
<li>
<p>8 ⋅ (47,71)</p>
</li>
<li>
<p>21 ⋅ (47,71)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import FieldElement, Point
&gt;&gt;&gt; prime = 223
&gt;&gt;&gt; a = FieldElement(0, prime)
&gt;&gt;&gt; b = FieldElement(7, prime)
&gt;&gt;&gt; x1 = FieldElement(num=192, prime=prime)
&gt;&gt;&gt; y1 = FieldElement(num=105, prime=prime)
&gt;&gt;&gt; p = Point(x1,y1,a,b)
&gt;&gt;&gt; print(p+p)
Point(49,71)_0_7 FieldElement(223)
&gt;&gt;&gt; x1 = FieldElement(num=143, prime=prime)
&gt;&gt;&gt; y1 = FieldElement(num=98, prime=prime)
&gt;&gt;&gt; p = Point(x1,y1,a,b)
&gt;&gt;&gt; print(p+p)
Point(64,168)_0_7 FieldElement(223)
&gt;&gt;&gt; x1 = FieldElement(num=47, prime=prime)
&gt;&gt;&gt; y1 = FieldElement(num=71, prime=prime)
&gt;&gt;&gt; p = Point(x1,y1,a,b)
&gt;&gt;&gt; print(p+p)
Point(36,111)_0_7 FieldElement(223)
&gt;&gt;&gt; print(p+p+p+p)
Point(194,51)_0_7 FieldElement(223)
&gt;&gt;&gt; print(p+p+p+p+p+p+p+p)
Point(116,55)_0_7 FieldElement(223)
&gt;&gt;&gt; print(p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p+p)
Point(infinity)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_3">Exercise 5</h4>
<div class="paragraph">
<p>For the curve <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + 7 over <em>F</em><sub>223</sub>, find the order of the group generated by (15,86).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; prime = 223
&gt;&gt;&gt; a = FieldElement(0, prime)
&gt;&gt;&gt; b = FieldElement(7, prime)
&gt;&gt;&gt; x = FieldElement(15, prime)
&gt;&gt;&gt; y = FieldElement(86, prime)
&gt;&gt;&gt; p = Point(x, y, a, b)
&gt;&gt;&gt; inf = Point(None, None, a, b)
&gt;&gt;&gt; product = p
&gt;&gt;&gt; count = 1
&gt;&gt;&gt; while product != inf:
...     product += p
...     count += 1
&gt;&gt;&gt; print(count)
7</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_3">Exercise 6</h4>
<div class="paragraph">
<p>Verify whether these signatures are valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>P = (0x887387e452b8eacc4acfde10d9aaf7f6d9a0f975aabb10d006e4da568744d06c,
     0x61de6d95231cd89026e286df3b6ae4a894a3378e393e93a0f45b666329a0ae34)

# signature 1
z = 0xec208baa0fc1c19f708a9ca96fdeff3ac3f230bb4a7ba4aede4942ad003c0f60
r = 0xac8d1c87e51d0d441be8b3dd5b05c8795b48875dffe00b7ffcfac23010d3a395
s = 0x68342ceff8935ededd102dd876ffd6ba72d6a427a3edb13d26eb0781cb423c4

# signature 2
z = 0x7c076ff316692a3d7eb3c3bb0f8b1488cf72e1afcd929e29307032997a838a3d
r = 0xeff69ef2b1bd93a66ed5219add4fb51e11a840f404876325a1e8ffe0529a2c
s = 0xc7207fee197d27c618aea621406f6bf5ef6fca38681d82b2f06fddbdce6feab6</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import S256Point, N, G
&gt;&gt;&gt; point = S256Point(
...     0x887387e452b8eacc4acfde10d9aaf7f6d9a0f975aabb10d006e4da568744d06c,
...     0x61de6d95231cd89026e286df3b6ae4a894a3378e393e93a0f45b666329a0ae34)
&gt;&gt;&gt; z = 0xec208baa0fc1c19f708a9ca96fdeff3ac3f230bb4a7ba4aede4942ad003c0f60
&gt;&gt;&gt; r = 0xac8d1c87e51d0d441be8b3dd5b05c8795b48875dffe00b7ffcfac23010d3a395
&gt;&gt;&gt; s = 0x68342ceff8935ededd102dd876ffd6ba72d6a427a3edb13d26eb0781cb423c4
&gt;&gt;&gt; u = z * pow(s, N-2, N) % N
&gt;&gt;&gt; v = r * pow(s, N-2, N) % N
&gt;&gt;&gt; print((u*G + v*point).x.num == r)
True
&gt;&gt;&gt; z = 0x7c076ff316692a3d7eb3c3bb0f8b1488cf72e1afcd929e29307032997a838a3d
&gt;&gt;&gt; r = 0xeff69ef2b1bd93a66ed5219add4fb51e11a840f404876325a1e8ffe0529a2c
&gt;&gt;&gt; s = 0xc7207fee197d27c618aea621406f6bf5ef6fca38681d82b2f06fddbdce6feab6
&gt;&gt;&gt; u = z * pow(s, N-2, N) % N
&gt;&gt;&gt; v = r * pow(s, N-2, N) % N
&gt;&gt;&gt; print((u*G + v*point).x.num == r)
True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7_3">Exercise 7</h4>
<div class="paragraph">
<p>Sign the following message with the secret:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>e = 12345
z = int.from_bytes(hash256('Programming Bitcoin!'), 'big')</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import S256Point, G, N
&gt;&gt;&gt; from helper import hash256
&gt;&gt;&gt; e = 12345
&gt;&gt;&gt; z = int.from_bytes(hash256(b'Programming Bitcoin!'), 'big')
&gt;&gt;&gt; k = 1234567890
&gt;&gt;&gt; r = (k*G).x.num
&gt;&gt;&gt; k_inv = pow(k, N-2, N)
&gt;&gt;&gt; s = (z+r*e) * k_inv % N
&gt;&gt;&gt; print(e*G)
S256Point(f01d6b9018ab421dd410404cb869072065522bf85734008f105cf385a023a80f, \
0eba29d0f0c5408ed681984dc525982abefccd9f7ff01dd26da4999cf3f6a295)
&gt;&gt;&gt; print(hex(z))
0x969f6056aa26f7d2795fd013fe88868d09c9f6aed96965016e1936ae47060d48
&gt;&gt;&gt; print(hex(r))
0x2b698a0f0a4041b77e63488ad48c23e8e8838dd1fb7520408b121697b782ef22
&gt;&gt;&gt; print(hex(s))
0x1dbc63bfef4416705e602a7b564161167076d8b20990a0f26f316cff2cb0bc1a</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_serialization_serialization"><a href="#chapter_serialization">[chapter_serialization]</a>: Serialization</h3>
<div class="sect3">
<h4 id="_exercise_1_4">Exercise 1</h4>
<div class="paragraph">
<p>Find the uncompressed SEC format for the public key where the private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5,000</p>
</li>
<li>
<p>2,018<sup>5</sup></p>
</li>
<li>
<p>0xdeadbeef12345</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; priv = PrivateKey(5000)
&gt;&gt;&gt; print(priv.point.sec(compressed=False).hex())
04ffe558e388852f0120e46af2d1b370f85854a8eb0841811ece0e3e03d282d57c315dc72890a4\
f10a1481c031b03b351b0dc79901ca18a00cf009dbdb157a1d10
&gt;&gt;&gt; priv = PrivateKey(2018**5)
&gt;&gt;&gt; print(priv.point.sec(compressed=False).hex())
04027f3da1918455e03c46f659266a1bb5204e959db7364d2f473bdf8f0a13cc9dff87647fd023\
c13b4a4994f17691895806e1b40b57f4fd22581a4f46851f3b06
&gt;&gt;&gt; priv = PrivateKey(0xdeadbeef12345)
&gt;&gt;&gt; print(priv.point.sec(compressed=False).hex())
04d90cd625ee87dd38656dd95cf79f65f60f7273b67d3096e68bd81e4f5342691f842efa762fd5\
9961d0e99803c61edba8b3e3f7dc3a341836f97733aebf987121</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_4">Exercise 2</h4>
<div class="paragraph">
<p>Find the compressed SEC format for the public key where the private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5,001</p>
</li>
<li>
<p>2,019<sup>5</sup></p>
</li>
<li>
<p>0xdeadbeef54321</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; priv = PrivateKey(5001)
&gt;&gt;&gt; print(priv.point.sec(compressed=True).hex())
0357a4f368868a8a6d572991e484e664810ff14c05c0fa023275251151fe0e53d1
&gt;&gt;&gt; priv = PrivateKey(2019**5)
&gt;&gt;&gt; print(priv.point.sec(compressed=True).hex())
02933ec2d2b111b92737ec12f1c5d20f3233a0ad21cd8b36d0bca7a0cfa5cb8701
&gt;&gt;&gt; priv = PrivateKey(0xdeadbeef54321)
&gt;&gt;&gt; print(priv.point.sec(compressed=True).hex())
0296be5b1292f6c856b3c5654e886fc13511462059089cdf9c479623bfcbe77690</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_4">Exercise 3</h4>
<div class="paragraph">
<p>Find the DER format for a signature whose <code>r</code> and <code>s</code> values are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>r = 0x37206a0610995c58074999cb9767b87af4c4978db68c06e8e6e81d282047a7c6

s = 0x8ca63759c1157ebeaec0d03cecca119fc9a75bf8e6d0fa65c841c8e2738cdaec</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import Signature
&gt;&gt;&gt; r = 0x37206a0610995c58074999cb9767b87af4c4978db68c06e8e6e81d282047a7c6
&gt;&gt;&gt; s = 0x8ca63759c1157ebeaec0d03cecca119fc9a75bf8e6d0fa65c841c8e2738cdaec
&gt;&gt;&gt; sig = Signature(r,s)
&gt;&gt;&gt; print(sig.der().hex())
3045022037206a0610995c58074999cb9767b87af4c4978db68c06e8e6e81d282047a7c6022100\
8ca63759c1157ebeaec0d03cecca119fc9a75bf8e6d0fa65c841c8e2738cdaec</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_4">Exercise 4</h4>
<div class="paragraph">
<p>Convert the following hex values to binary and then to Base58:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>7c076ff316692a3d7eb3c3bb0f8b1488cf72e1afcd929e29307032997a838a3d</code></p>
</li>
<li>
<p><code>eff69ef2b1bd93a66ed5219add4fb51e11a840f404876325a1e8ffe0529a2c</code></p>
</li>
<li>
<p><code>c7207fee197d27c618aea621406f6bf5ef6fca38681d82b2f06fddbdce6feab6</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import encode_base58
&gt;&gt;&gt; h = '7c076ff316692a3d7eb3c3bb0f8b1488cf72e1afcd929e29307032997a838a3d'
&gt;&gt;&gt; print(encode_base58(bytes.fromhex(h)))
9MA8fRQrT4u8Zj8ZRd6MAiiyaxb2Y1CMpvVkHQu5hVM6
&gt;&gt;&gt; h = 'eff69ef2b1bd93a66ed5219add4fb51e11a840f404876325a1e8ffe0529a2c'
&gt;&gt;&gt; print(encode_base58(bytes.fromhex(h)))
4fE3H2E6XMp4SsxtwinF7w9a34ooUrwWe4WsW1458Pd
&gt;&gt;&gt; h = 'c7207fee197d27c618aea621406f6bf5ef6fca38681d82b2f06fddbdce6feab6'
&gt;&gt;&gt; print(encode_base58(bytes.fromhex(h)))
EQJsjkd6JaGwxrjEhfeqPenqHwrBmPQZjJGNSCHBkcF7</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_4">Exercise 5</h4>
<div class="paragraph">
<p>Find the addresses corresponding to the public keys whose private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5002 (use uncompressed SEC on testnet)</p>
</li>
<li>
<p>2020<sup>5</sup> (use compressed SEC on testnet)</p>
</li>
<li>
<p>0x12345deadbeef (use compressed SEC on mainnet)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; priv = PrivateKey(5002)
&gt;&gt;&gt; print(priv.point.address(compressed=False, testnet=True))
mmTPbXQFxboEtNRkwfh6K51jvdtHLxGeMA
&gt;&gt;&gt; priv = PrivateKey(2020**5)
&gt;&gt;&gt; print(priv.point.address(compressed=True, testnet=True))
mopVkxp8UhXqRYbCYJsbeE1h1fiF64jcoH
&gt;&gt;&gt; priv = PrivateKey(0x12345deadbeef)
&gt;&gt;&gt; print(priv.point.address(compressed=True, testnet=False))
1F1Pn2y6pDb68E5nYJJeba4TLg2U7B6KF1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_4">Exercise 6</h4>
<div class="paragraph">
<p>Find the WIF for the private key whose secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5003 (compressed, testnet)</p>
</li>
<li>
<p>2021<sup>5</sup> (uncompressed, testnet)</p>
</li>
<li>
<p>0x54321deadbeef (compressed, mainnet)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; priv = PrivateKey(5003)
&gt;&gt;&gt; print(priv.wif(compressed=True, testnet=True))
cMahea7zqjxrtgAbB7LSGbcQUr1uX1ojuat9jZodMN8rFTv2sfUK
&gt;&gt;&gt; priv = PrivateKey(2021**5)
&gt;&gt;&gt; print(priv.wif(compressed=False, testnet=True))
91avARGdfge8E4tZfYLoxeJ5sGBdNJQH4kvjpWAxgzczjbCwxic
&gt;&gt;&gt; priv = PrivateKey(0x54321deadbeef)
&gt;&gt;&gt; print(priv.wif(compressed=True, testnet=False))
KwDiBf89QgGbjEhKnhXJuH7LrciVrZi3qYjgiuQJv1h8Ytr2S53a</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7_4">Exercise 7</h4>
<div class="paragraph">
<p>Write a function <code>little_endian_to_int</code> that takes Python bytes, interprets those bytes in little-endian, and returns the number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def little_endian_to_int(b):
    '''little_endian_to_int takes byte sequence as a little-endian number.
    Returns an integer'''
    return int.from_bytes(b, 'little')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_8_2">Exercise 8</h4>
<div class="paragraph">
<p>Write a function <code>int_to_little_endian</code> that does the reverse of the last exercise.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def int_to_little_endian(n, length):
    '''endian_to_little_endian takes an integer and returns the little-endian
    byte sequence of length'''
    return n.to_bytes(length, 'little')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_9_2">Exercise 9</h4>
<div class="paragraph">
<p>Create a testnet address for yourself using a long secret that only you know. This is important as there are bots on testnet trying to steal testnet coins. Make sure you write this secret down somewhere! You will be using it later to sign transactions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; from helper import hash256, little_endian_to_int
&gt;&gt;&gt; passphrase = b'jimmy@programmingblockchain.com my secret'
&gt;&gt;&gt; secret = little_endian_to_int(hash256(passphrase))
&gt;&gt;&gt; priv = PrivateKey(secret)
&gt;&gt;&gt; print(priv.point.address(testnet=True))
mft9LRNtaBNtpkknB8xgm17UvPedZ4ecYL</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_tx_parsing_transactions"><a href="#chapter_tx_parsing">[chapter_tx_parsing]</a>: Transactions</h3>
<div class="sect3">
<h4 id="_exercise_1_5">Exercise 1</h4>
<div class="paragraph">
<p>Write the version parsing part of the <code>parse</code> method that we&#8217;ve defined. To do this properly, you&#8217;ll have to convert 4 bytes into a little-endian integer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
@classmethod
def parse(cls, s, testnet=False):
    version = little_endian_to_int(s.read(4))
    return cls(version, None, None, None, testnet=testnet)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_5">Exercise 2</h4>
<div class="paragraph">
<p>Write the inputs parsing part of the <code>parse</code> method in <code>Tx</code> and the <code>parse</code> method for <code>TxIn</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    @classmethod
    def parse(cls, s, testnet=False):
        version = little_endian_to_int(s.read(4))
        num_inputs = read_varint(s)
        inputs = []
        for _ in range(num_inputs):
            inputs.append(TxIn.parse(s))
        return cls(version, inputs, None, None, testnet=testnet)
...

class TxIn:
...
    @classmethod
    def parse(cls, s):
        '''Takes a byte stream and parses the tx_input at the start.
        Returns a TxIn object.
        '''
        prev_tx = s.read(32)[::-1]
        prev_index = little_endian_to_int(s.read(4))
        script_sig = Script.parse(s)
        sequence = little_endian_to_int(s.read(4))
        return cls(prev_tx, prev_index, script_sig, sequence)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_5">Exercise 3</h4>
<div class="paragraph">
<p>Write the outputs parsing part of the <code>parse</code> method in <code>Tx</code> and the <code>parse</code> method for <code>TxOut</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
class Tx:
...
    @classmethod
    def parse(cls, s, testnet=False):
        version = little_endian_to_int(s.read(4))
        num_inputs = read_varint(s)
        inputs = []
        for _ in range(num_inputs):
            inputs.append(TxIn.parse(s))
        num_outputs = read_varint(s)
        outputs = []
        for _ in range(num_outputs):
            outputs.append(TxOut.parse(s))
        return cls(version, inputs, outputs, None, testnet=testnet)
...

class TxOut:
...
    @classmethod
    def parse(cls, s):
        '''Takes a byte stream and parses the tx_output at the start.
        Returns a TxOut object.
        '''
        amount = little_endian_to_int(s.read(8))
        script_pubkey = Script.parse(s)
        return cls(amount, script_pubkey)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_5">Exercise 4</h4>
<div class="paragraph">
<p>Write the locktime parsing part of the <code>parse</code> method in <code>Tx</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
@classmethod
def parse(cls, s, testnet=False):
    version = little_endian_to_int(s.read(4))
    num_inputs = read_varint(s)
    inputs = []
    for _ in range(num_inputs):
        inputs.append(TxIn.parse(s))
    num_outputs = read_varint(s)
    outputs = []
    for _ in range(num_outputs):
        outputs.append(TxOut.parse(s))
    locktime = little_endian_to_int(s.read(4))
    return cls(version, inputs, outputs, locktime, testnet=testnet)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_5">Exercise 5</h4>
<div class="paragraph">
<p>What are the ScriptSig of the second input, the ScriptPubKey of the first output, and the amount of the second output for this transaction?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>010000000456919960ac691763688d3d3bcea9ad6ecaf875df5339e148a1fc61c6ed7a069e0100
00006a47304402204585bcdef85e6b1c6af5c2669d4830ff86e42dd205c0e089bc2a821657e951
c002201024a10366077f87d6bce1f7100ad8cfa8a064b39d4e8fe4ea13a7b71aa8180f012102f0
da57e85eec2934a82a585ea337ce2f4998b50ae699dd79f5880e253dafafb7feffffffeb8f51f4
038dc17e6313cf831d4f02281c2a468bde0fafd37f1bf882729e7fd3000000006a473044022078
99531a52d59a6de200179928ca900254a36b8dff8bb75f5f5d71b1cdc26125022008b422690b84
61cb52c3cc30330b23d574351872b7c361e9aae3649071c1a7160121035d5c93d9ac96881f19ba
1f686f15f009ded7c62efe85a872e6a19b43c15a2937feffffff567bf40595119d1bb8a3037c35
6efd56170b64cbcc160fb028fa10704b45d775000000006a47304402204c7c7818424c7f7911da
6cddc59655a70af1cb5eaf17c69dadbfc74ffa0b662f02207599e08bc8023693ad4e9527dc42c3
4210f7a7d1d1ddfc8492b654a11e7620a0012102158b46fbdff65d0172b7989aec8850aa0dae49
abfb84c81ae6e5b251a58ace5cfeffffffd63a5e6c16e620f86f375925b21cabaf736c779f88fd
04dcad51d26690f7f345010000006a47304402200633ea0d3314bea0d95b3cd8dadb2ef79ea833
1ffe1e61f762c0f6daea0fabde022029f23b3e9c30f080446150b23852028751635dcee2be669c
2a1686a4b5edf304012103ffd6f4a67e94aba353a00882e563ff2722eb4cff0ad6006e86ee20df
e7520d55feffffff0251430f00000000001976a914ab0c0b2e98b1ab6dbf67d4750b0a56244948
a87988ac005a6202000000001976a9143c82d7df364eb6c75be8c80df2b3eda8db57397088ac46
430600</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from tx import Tx
&gt;&gt;&gt; hex_transaction = '010000000456919960ac691763688d3d3bcea9ad6ecaf875df5339e\
148a1fc61c6ed7a069e010000006a47304402204585bcdef85e6b1c6af5c2669d4830ff86e42dd\
205c0e089bc2a821657e951c002201024a10366077f87d6bce1f7100ad8cfa8a064b39d4e8fe4e\
a13a7b71aa8180f012102f0da57e85eec2934a82a585ea337ce2f4998b50ae699dd79f5880e253\
dafafb7feffffffeb8f51f4038dc17e6313cf831d4f02281c2a468bde0fafd37f1bf882729e7fd\
3000000006a47304402207899531a52d59a6de200179928ca900254a36b8dff8bb75f5f5d71b1c\
dc26125022008b422690b8461cb52c3cc30330b23d574351872b7c361e9aae3649071c1a716012\
1035d5c93d9ac96881f19ba1f686f15f009ded7c62efe85a872e6a19b43c15a2937feffffff567\
bf40595119d1bb8a3037c356efd56170b64cbcc160fb028fa10704b45d775000000006a4730440\
2204c7c7818424c7f7911da6cddc59655a70af1cb5eaf17c69dadbfc74ffa0b662f02207599e08\
bc8023693ad4e9527dc42c34210f7a7d1d1ddfc8492b654a11e7620a0012102158b46fbdff65d0\
172b7989aec8850aa0dae49abfb84c81ae6e5b251a58ace5cfeffffffd63a5e6c16e620f86f375\
925b21cabaf736c779f88fd04dcad51d26690f7f345010000006a47304402200633ea0d3314bea\
0d95b3cd8dadb2ef79ea8331ffe1e61f762c0f6daea0fabde022029f23b3e9c30f080446150b23\
852028751635dcee2be669c2a1686a4b5edf304012103ffd6f4a67e94aba353a00882e563ff272\
2eb4cff0ad6006e86ee20dfe7520d55feffffff0251430f00000000001976a914ab0c0b2e98b1a\
b6dbf67d4750b0a56244948a87988ac005a6202000000001976a9143c82d7df364eb6c75be8c80\
df2b3eda8db57397088ac46430600'
&gt;&gt;&gt; stream = BytesIO(bytes.fromhex(hex_transaction))
&gt;&gt;&gt; tx_obj = Tx.parse(stream)
&gt;&gt;&gt; print(tx_obj.tx_ins[1].script_sig)
304402207899531a52d59a6de200179928ca900254a36b8dff8bb75f5f5d71b1cdc26125022008\
b422690b8461cb52c3cc30330b23d574351872b7c361e9aae3649071c1a71601 035d5c93d9ac9\
6881f19ba1f686f15f009ded7c62efe85a872e6a19b43c15a2937
&gt;&gt;&gt; print(tx_obj.tx_outs[0].script_pubkey)
OP_DUP OP_HASH160 ab0c0b2e98b1ab6dbf67d4750b0a56244948a879 \
OP_EQUALVERIFY OP_CHECKSIG
&gt;&gt;&gt; print(tx_obj.tx_outs[1].amount)
40000000</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_5">Exercise 6</h4>
<div class="paragraph">
<p>Write the <code>fee</code> method for the <code>Tx</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def fee(self, testnet=False):
        input_sum, output_sum = 0, 0
        for tx_in in self.tx_ins:
            input_sum += tx_in.value(testnet=testnet)
        for tx_out in self.tx_outs:
            output_sum += tx_out.amount
        return input_sum - output_sum</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_script_script"><a href="#chapter_script">[chapter_script]</a>: Script</h3>
<div class="sect3">
<h4 id="_exercise_1_6">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>op_hash160</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def op_hash160(stack):
    if len(stack) &lt; 1:
        return False
    element = stack.pop()
    h160 = hash160(element)
    stack.append(h160)
    return True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_6">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>op_checksig</code> function in <em>op.py</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def op_checksig(stack, z):
    if len(stack) &lt; 2:
        return False
    sec_pubkey = stack.pop()
    der_signature = stack.pop()[:-1]
    try:
        point = S256Point.parse(sec_pubkey)
        sig = Signature.parse(der_signature)
    except (ValueError, SyntaxError) as e:
        return False
    if point.verify(z, sig):
        stack.append(encode_num(1))
    else:
        stack.append(encode_num(0))
    return True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_6">Exercise 3</h4>
<div class="paragraph">
<p>Create a ScriptSig that can unlock this ScriptPubKey:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>767695935687</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>OP_MUL</code> multiplies the top two elements of the stack.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>56 = OP_6</code></p>
</li>
<li>
<p><code>76 = OP_DUP</code></p>
</li>
<li>
<p><code>87 = OP_EQUAL</code></p>
</li>
<li>
<p><code>93 = OP_ADD</code></p>
</li>
<li>
<p><code>95 = OP_MUL</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from script import Script
&gt;&gt;&gt; script_pubkey = Script([0x76, 0x76, 0x95, 0x93, 0x56, 0x87])
&gt;&gt;&gt; script_sig = Script([0x52])
&gt;&gt;&gt; combined_script = script_sig + script_pubkey
&gt;&gt;&gt; print(combined_script.evaluate(0))
True</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>OP_2</code> or <code>52</code> will satisfy the equation <em>x</em><sup>2</sup> + <em>x</em> – 6 = 0.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_6">Exercise 4</h4>
<div class="paragraph">
<p>Figure out what this script is doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>6e879169a77ca787</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>69 = OP_VERIFY</code></p>
</li>
<li>
<p><code>6e = OP_2DUP</code></p>
</li>
<li>
<p><code>7c = OP_SWAP</code></p>
</li>
<li>
<p><code>87 = OP_EQUAL</code></p>
</li>
<li>
<p><code>91 = OP_NOT</code></p>
</li>
<li>
<p><code>a7 = OP_SHA1</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use the <code>Script.parse</code> method and look up what various opcodes do at <a href="https://en.bitcoin.it/wiki/Script" class="bare">https://en.bitcoin.it/wiki/Script</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from script import Script
&gt;&gt;&gt; script_pubkey = Script([0x6e, 0x87, 0x91, 0x69, 0xa7, 0x7c, 0xa7, 0x87])
&gt;&gt;&gt; c1 = '255044462d312e330a25e2e3cfd30a0a0a312030206f626a0a3c3c2f576964746820\
32203020522f4865696768742033203020522f547970652034203020522f537562747970652035\
203020522f46696c7465722036203020522f436f6c6f7253706163652037203020522f4c656e67\
74682038203020522f42697473506572436f6d706f6e656e7420383e3e0a73747265616d0affd8\
fffe00245348412d3120697320646561642121212121852fec092339759c39b1a1c63c4c97e1ff\
fe017f46dc93a6b67e013b029aaa1db2560b45ca67d688c7f84b8c4c791fe02b3df614f86db169\
0901c56b45c1530afedfb76038e972722fe7ad728f0e4904e046c230570fe9d41398abe12ef5bc\
942be33542a4802d98b5d70f2a332ec37fac3514e74ddc0f2cc1a874cd0c78305a215664613097\
89606bd0bf3f98cda8044629a1'
&gt;&gt;&gt; c2 = '255044462d312e330a25e2e3cfd30a0a0a312030206f626a0a3c3c2f576964746820\
32203020522f4865696768742033203020522f547970652034203020522f537562747970652035\
203020522f46696c7465722036203020522f436f6c6f7253706163652037203020522f4c656e67\
74682038203020522f42697473506572436f6d706f6e656e7420383e3e0a73747265616d0affd8\
fffe00245348412d3120697320646561642121212121852fec092339759c39b1a1c63c4c97e1ff\
fe017346dc9166b67e118f029ab621b2560ff9ca67cca8c7f85ba84c79030c2b3de218f86db3a9\
0901d5df45c14f26fedfb3dc38e96ac22fe7bd728f0e45bce046d23c570feb141398bb552ef5a0\
a82be331fea48037b8b5d71f0e332edf93ac3500eb4ddc0decc1a864790c782c76215660dd3097\
91d06bd0af3f98cda4bc4629b1'
&gt;&gt;&gt; collision1 = bytes.fromhex(c1)  # <b class="conum">(1)</b>
&gt;&gt;&gt; collision2 = bytes.fromhex(c2)
&gt;&gt;&gt; script_sig = Script([collision1, collision2])
&gt;&gt;&gt; combined_script = script_sig + script_pubkey
&gt;&gt;&gt; print(combined_script.evaluate(0))
True</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>collision1</code> and <code>collision2</code> are from the SHA-1 preimages that <a href="http://bit.ly/2HZF3om">Google found to collide</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is looking for a SHA-1 collision. The only way to satisfy this script is to give <code>x</code> and <code>y</code> such that <code>x≠y</code> but <code>sha1(x)=sha1(y)</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_tx_transaction_creation_and_validation"><a href="#chapter_tx">[chapter_tx]</a>: Transaction Creation and Validation</h3>
<div class="sect3">
<h4 id="_exercise_1_7">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>sig_hash</code> method for the <code>Tx</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def sig_hash(self, input_index):
        s = int_to_little_endian(self.version, 4)
        s += encode_varint(len(self.tx_ins))
        for i, tx_in in enumerate(self.tx_ins):
            if i == input_index:
                s += TxIn(
                    prev_tx=tx_in.prev_tx,
                    prev_index=tx_in.prev_index,
                    script_sig=tx_in.script_pubkey(self.testnet),
                    sequence=tx_in.sequence,
                ).serialize()
            else:
                s += TxIn(
                    prev_tx=tx_in.prev_tx,
                    prev_index=tx_in.prev_index,
                    sequence=tx_in.sequence,
                ).serialize()
        s += encode_varint(len(self.tx_outs))
        for tx_out in self.tx_outs:
            s += tx_out.serialize()
        s += int_to_little_endian(self.locktime, 4)
        s += int_to_little_endian(SIGHASH_ALL, 4)
        h256 = hash256(s)
        return int.from_bytes(h256, 'big')</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_7">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>verify_input</code> method for the <code>Tx</code> class. You will want to use the <code>TxIn.script_pubkey</code>, <code>Tx.sig_hash</code>, and <code>Script.evaluate</code> methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def verify_input(self, input_index):
        tx_in = self.tx_ins[input_index]
        script_pubkey = tx_in.script_pubkey(testnet=self.testnet)
        z = self.sig_hash(input_index)
        combined = tx_in.script_sig + script_pubkey
        return combined.evaluate(z)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_7">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>sign_input</code> method for the <code>Tx</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def sign_input(self, input_index, private_key):
        z = self.sig_hash(input_index)
        der = private_key.sign(z).der()
        sig = der + SIGHASH_ALL.to_bytes(1, 'big')
        sec = private_key.point.sec()
        self.tx_ins[input_index].script_sig = Script([sig, sec])
        return self.verify_input(input_index)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_7">Exercise 4</h4>
<div class="paragraph">
<p>Create a testnet transaction that sends 60% of a single UTXO to <code>mwJn1YPMq7y5F8J3LkC5Hxg9PHyZ5K4cFv</code>. The remaining amount minus fees should go back to your own change address. This should be a one-input, two-output <span class="keep-together">transaction</span>.</p>
</div>
<div class="paragraph">
<p>You can broadcast the transaction at <a href="https://blockstream.info/testnet/tx/push" class="bare">https://blockstream.info/testnet/tx/push</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; from helper import decode_base58, SIGHASH_ALL
&gt;&gt;&gt; from script import p2pkh_script, Script
&gt;&gt;&gt; from tx import TxIn, TxOut, Tx
&gt;&gt;&gt; prev_tx = bytes.fromhex('75a1c4bc671f55f626dda1074c7725991e6f68b8fcefcfca7\
b64405ca3b45f1c')
&gt;&gt;&gt; prev_index = 1
&gt;&gt;&gt; target_address = 'miKegze5FQNCnGw6PKyqUbYUeBa4x2hFeM'
&gt;&gt;&gt; target_amount = 0.01
&gt;&gt;&gt; change_address = 'mzx5YhAH9kNHtcN481u6WkjeHjYtVeKVh2'
&gt;&gt;&gt; change_amount = 0.009
&gt;&gt;&gt; secret = 8675309
&gt;&gt;&gt; priv = PrivateKey(secret=secret)
&gt;&gt;&gt; tx_ins = []
&gt;&gt;&gt; tx_ins.append(TxIn(prev_tx, prev_index))
&gt;&gt;&gt; tx_outs = []
&gt;&gt;&gt; h160 = decode_base58(target_address)
&gt;&gt;&gt; script_pubkey = p2pkh_script(h160)
&gt;&gt;&gt; target_satoshis = int(target_amount*100000000)
&gt;&gt;&gt; tx_outs.append(TxOut(target_satoshis, script_pubkey))
&gt;&gt;&gt; h160 = decode_base58(change_address)
&gt;&gt;&gt; script_pubkey = p2pkh_script(h160)
&gt;&gt;&gt; change_satoshis = int(change_amount*100000000)
&gt;&gt;&gt; tx_outs.append(TxOut(change_satoshis, script_pubkey))
&gt;&gt;&gt; tx_obj = Tx(1, tx_ins, tx_outs, 0, testnet=True)
&gt;&gt;&gt; print(tx_obj.sign_input(0, priv))
True
&gt;&gt;&gt; print(tx_obj.serialize().hex())
01000000011c5fb4a35c40647bcacfeffcb8686f1e9925774c07a1dd26f6551f67bcc4a1750100\
00006b483045022100a08ebb92422b3599a2d2fcdaa11f8f807a66ccf33e7f4a9ff0a3c51f1b1e\
c5dd02205ed21dfede5925362b8d9833e908646c54be7ac6664e31650159e8f69b6ca539012103\
935581e52c354cd2f484fe8ed83af7a3097005b2f9c60bff71d35bd795f54b67ffffffff024042\
0f00000000001976a9141ec51b3654c1f1d0f4929d11a1f702937eaf50c888ac9fbb0d00000000\
001976a914d52ad7ca9b3d096a38e752c2018e6fbc40cdf26f88ac00000000</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_6">Exercise 5</h4>
<div class="paragraph">
<p>Advanced: Get some more testnet coins from a testnet faucet and create a two-input, one-output transaction. One input should be from the faucet, the other should be from the previous exercise; the output can be your own address.</p>
</div>
<div class="paragraph">
<p>You can broadcast the transaction at <a href="https://blockstream.info/testnet/tx/push" class="bare">https://blockstream.info/testnet/tx/push</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; from helper import decode_base58, SIGHASH_ALL
&gt;&gt;&gt; from script import p2pkh_script, Script
&gt;&gt;&gt; from tx import TxIn, TxOut, Tx
&gt;&gt;&gt; prev_tx_1 = bytes.fromhex('11d05ce707c1120248370d1cbf5561d22c4f83aeba04367\
92c82e0bd57fe2a2f')
&gt;&gt;&gt; prev_index_1 = 1
&gt;&gt;&gt; prev_tx_2 = bytes.fromhex('51f61f77bd061b9a0da60d4bedaaf1b1fad0c11e65fdc74\
4797ee22d20b03d15')
&gt;&gt;&gt; prev_index_2 = 1
&gt;&gt;&gt; target_address = 'mwJn1YPMq7y5F8J3LkC5Hxg9PHyZ5K4cFv'
&gt;&gt;&gt; target_amount = 0.0429
&gt;&gt;&gt; secret = 8675309
&gt;&gt;&gt; priv = PrivateKey(secret=secret)
&gt;&gt;&gt; tx_ins = []
&gt;&gt;&gt; tx_ins.append(TxIn(prev_tx_1, prev_index_1))
&gt;&gt;&gt; tx_ins.append(TxIn(prev_tx_2, prev_index_2))
&gt;&gt;&gt; tx_outs = []
&gt;&gt;&gt; h160 = decode_base58(target_address)
&gt;&gt;&gt; script_pubkey = p2pkh_script(h160)
&gt;&gt;&gt; target_satoshis = int(target_amount*100000000)
&gt;&gt;&gt; tx_outs.append(TxOut(target_satoshis, script_pubkey))
&gt;&gt;&gt; tx_obj = Tx(1, tx_ins, tx_outs, 0, testnet=True)
&gt;&gt;&gt; print(tx_obj.sign_input(0, priv))
True
&gt;&gt;&gt; print(tx_obj.sign_input(1, priv))
True
&gt;&gt;&gt; print(tx_obj.serialize().hex())
01000000022f2afe57bde0822c793604baae834f2cd26155bf1c0d37480212c107e75cd0110100\
00006a47304402204cc5fe11b2b025f8fc9f6073b5e3942883bbba266b71751068badeb8f11f03\
64022070178363f5dea4149581a4b9b9dbad91ec1fd990e3fa14f9de3ccb421fa5b26901210393\
5581e52c354cd2f484fe8ed83af7a3097005b2f9c60bff71d35bd795f54b67ffffffff153db020\
2de27e7944c7fd651ec1d0fab1f1aaed4b0da60d9a1b06bd771ff651010000006b483045022100\
b7a938d4679aa7271f0d32d83b61a85eb0180cf1261d44feaad23dfd9799dafb02205ff2f366dd\
d9555f7146861a8298b7636be8b292090a224c5dc84268480d8be1012103935581e52c354cd2f4\
84fe8ed83af7a3097005b2f9c60bff71d35bd795f54b67ffffffff01d0754100000000001976a9\
14ad346f8eb57dee9a37981716e498120ae80e44f788ac00000000</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_p2sh_pay_to_script_hash"><a href="#chapter_p2sh">[chapter_p2sh]</a>: Pay to Script Hash</h3>
<div class="sect3">
<h4 id="_exercise_1_8">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>op_checkmultisig</code> function of <em>op.py</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def op_checkmultisig(stack, z):
    if len(stack) &lt; 1:
        return False
    n = decode_num(stack.pop())
    if len(stack) &lt; n + 1:
        return False
    sec_pubkeys = []
    for _ in range(n):
        sec_pubkeys.append(stack.pop())
    m = decode_num(stack.pop())
    if len(stack) &lt; m + 1:
        return False
    der_signatures = []
    for _ in range(m):
        der_signatures.append(stack.pop()[:-1])
    stack.pop()
    try:
        points = [S256Point.parse(sec) for sec in sec_pubkeys]
        sigs = [Signature.parse(der) for der in der_signatures]
        for sig in sigs:
            if len(points) == 0:
                return False
            while points:
                point = points.pop(0)
                if point.verify(z, sig):
                    break
        stack.append(encode_num(1))
    except (ValueError, SyntaxError):
        return False
    return True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_8">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>h160_to_p2pkh_address</code> function that converts a 20-byte hash160 into a p2pkh address.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def h160_to_p2pkh_address(h160, testnet=False):
    if testnet:
        prefix = b'\x6f'
    else:
        prefix = b'\x00'
    return encode_base58_checksum(prefix + h160)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_8">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>h160_to_p2sh_address</code> function that converts a 20-byte hash160 into a p2sh address.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def h160_to_p2sh_address(h160, testnet=False):
    if testnet:
        prefix = b'\xc4'
    else:
        prefix = b'\x05'
    return encode_base58_checksum(prefix + h160)</code></pre>
</div>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_exercise_4_8">Exercise 4</h4>
<div class="paragraph">
<p>Validate the second signature from the preceding transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from ecc import S256Point, Signature
&gt;&gt;&gt; from helper import hash256, int_to_little_endian
&gt;&gt;&gt; from script import Script
&gt;&gt;&gt; from tx import Tx, SIGHASH_ALL
&gt;&gt;&gt; hex_tx = '0100000001868278ed6ddfb6c1ed3ad5f8181eb0c7a385aa0836f01d5e4789e6\
bd304d87221a000000db00483045022100dc92655fe37036f47756db8102e0d7d5e28b3beb83a8\
fef4f5dc0559bddfb94e02205a36d4e4e6c7fcd16658c50783e00c341609977aed3ad00937bf4e\
e942a8993701483045022100da6bee3c93766232079a01639d07fa869598749729ae323eab8eef\
53577d611b02207bef15429dcadce2121ea07f233115c6f09034c0be68db99980b9a6c5e754022\
01475221022626e955ea6ea6d98850c994f9107b036b1334f18ca8830bfff1295d21cfdb702103\
b287eaf122eea69030a0e9feed096bed8045c8b98bec453e1ffac7fbdbd4bb7152aeffffffff04\
d3b11400000000001976a914904a49878c0adfc3aa05de7afad2cc15f483a56a88ac7f40090000\
0000001976a914418327e3f3dda4cf5b9089325a4b95abdfa0334088ac722c0c00000000001976\
a914ba35042cfe9fc66fd35ac2224eebdafd1028ad2788acdc4ace020000000017a91474d691da\
1574e6b3c192ecfb52cc8984ee7b6c568700000000'
&gt;&gt;&gt; hex_sec = '03b287eaf122eea69030a0e9feed096bed8045c8b98bec453e1ffac7fbdbd4b\
b71'
&gt;&gt;&gt; hex_der = '3045022100da6bee3c93766232079a01639d07fa869598749729ae323eab8ee\
f53577d611b02207bef15429dcadce2121ea07f233115c6f09034c0be68db99980b9a6c5e75402\
2'
&gt;&gt;&gt; hex_redeem_script = '475221022626e955ea6ea6d98850c994f9107b036b1334f18ca88\
30bfff1295d21cfdb702103b287eaf122eea69030a0e9feed096bed8045c8b98bec453e1ffac7f\
bdbd4bb7152ae'
&gt;&gt;&gt; sec = bytes.fromhex(hex_sec)
&gt;&gt;&gt; der = bytes.fromhex(hex_der)
&gt;&gt;&gt; redeem_script = Script.parse(BytesIO(bytes.fromhex(hex_redeem_script)))
&gt;&gt;&gt; stream = BytesIO(bytes.fromhex(hex_tx))
&gt;&gt;&gt; tx_obj = Tx.parse(stream)
&gt;&gt;&gt; s = int_to_little_endian(tx_obj.version, 4)
&gt;&gt;&gt; s += encode_varint(len(tx_obj.tx_ins))
&gt;&gt;&gt; i = tx_obj.tx_ins[0]
&gt;&gt;&gt; s += TxIn(i.prev_tx, i.prev_index, redeem_script, i.sequence).serialize()
&gt;&gt;&gt; s += encode_varint(len(tx_obj.tx_outs))
&gt;&gt;&gt; for tx_out in tx_obj.tx_outs:
...    s += tx_out.serialize()
&gt;&gt;&gt; s += int_to_little_endian(tx_obj.locktime, 4)
&gt;&gt;&gt; s += int_to_little_endian(SIGHASH_ALL, 4)
&gt;&gt;&gt; z = int.from_bytes(hash256(s), 'big')
&gt;&gt;&gt; point = S256Point.parse(sec)
&gt;&gt;&gt; sig = Signature.parse(der)
&gt;&gt;&gt; print(point.verify(z, sig))
True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_7">Exercise 5</h4>
<div class="paragraph">
<p>Modify the <code>sig_hash</code> and <code>verify_input</code> methods to be able to verify p2sh <span class="keep-together">transactions</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def sig_hash(self, input_index, redeem_script=None):
        '''Returns the integer representation of the hash that needs to get
        signed for index input_index'''
        s = int_to_little_endian(self.version, 4)
        s += encode_varint(len(self.tx_ins))
        for i, tx_in in enumerate(self.tx_ins):
            if i == input_index:
                if redeem_script:
                    script_sig = redeem_script
                else:
                    script_sig = tx_in.script_pubkey(self.testnet)
            else:
                script_sig = None
            s += TxIn(
                prev_tx=tx_in.prev_tx,
                prev_index=tx_in.prev_index,
                script_sig=script_sig,
                sequence=tx_in.sequence,
            ).serialize()
        s += encode_varint(len(self.tx_outs))
        for tx_out in self.tx_outs:
            s += tx_out.serialize()
        s += int_to_little_endian(self.locktime, 4)
        s += int_to_little_endian(SIGHASH_ALL, 4)
        h256 = hash256(s)
        return int.from_bytes(h256, 'big')


    def verify_input(self, input_index):
        tx_in = self.tx_ins[input_index]
        script_pubkey = tx_in.script_pubkey(testnet=self.testnet)
        if script_pubkey.is_p2sh_script_pubkey():
            cmd = tx_in.script_sig.cmds[-1]
            raw_redeem = encode_varint(len(cmd)) + cmd
            redeem_script = Script.parse(BytesIO(raw_redeem))
        else:
            redeem_script = None
        z = self.sig_hash(input_index, redeem_script)
        combined = tx_in.script_sig + script_pubkey
        return combined.evaluate(z)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_blocks_blocks"><a href="#chapter_blocks">[chapter_blocks]</a>: Blocks</h3>
<div class="sect3">
<h4 id="_exercise_1_9">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>is_coinbase</code> method of the <code>Tx</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def is_coinbase(self):
        if len(self.tx_ins) != 1:
            return False
        first_input = self.tx_ins[0]
        if first_input.prev_tx != b'\x00' * 32:
            return False
        if first_input.prev_index != 0xffffffff:
            return False
        return True</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_9">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>coinbase_height</code> method for the <code>Tx</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def coinbase_height(self):
        if not self.is_coinbase():
            return None
        element = self.tx_ins[0].script_sig.cmds[0]
        return little_endian_to_int(element)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_9">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>parse</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    @classmethod
    def parse(cls, s):
        version = little_endian_to_int(s.read(4))
        prev_block = s.read(32)[::-1]
        merkle_root = s.read(32)[::-1]
        timestamp = little_endian_to_int(s.read(4))
        bits = s.read(4)
        nonce = s.read(4)
        return cls(version, prev_block, merkle_root, timestamp, bits, nonce)</code></pre>
</div>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_exercise_4_9">Exercise 4</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def serialize(self):
        result = int_to_little_endian(self.version, 4)
        result += self.prev_block[::-1]
        result += self.merkle_root[::-1]
        result += int_to_little_endian(self.timestamp, 4)
        result += self.bits
        result += self.nonce
        return result</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_8">Exercise 5</h4>
<div class="paragraph">
<p>Write the <code>hash</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def hash(self):
        s = self.serialize()
        sha = hash256(s)
        return sha[::-1]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_6">Exercise 6</h4>
<div class="paragraph">
<p>Write the <code>bip9</code> method for the <code>Block</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def bip9(self):
        return self.version &gt;&gt; 29 == 0b001</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7_5">Exercise 7</h4>
<div class="paragraph">
<p>Write the <code>bip91</code> method for the <code>Block</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def bip91(self):
        return self.version &gt;&gt; 4 &amp; 1 == 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_8_3">Exercise 8</h4>
<div class="paragraph">
<p>Write the <code>bip141</code> method for the <code>Block</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def bip141(self):
        return self.version &gt;&gt; 1 &amp; 1 == 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_9_3">Exercise 9</h4>
<div class="paragraph">
<p>Write the <code>bits_to_target</code> function in <em>helper.py</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def bits_to_target(bits):
    exponent = bits[-1]
    coefficient = little_endian_to_int(bits[:-1])
    return coefficient * 256**(exponent - 3)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_10">Exercise 10</h4>
<div class="paragraph">
<p>Write the <code>difficulty</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def difficulty(self):
        lowest = 0xffff * 256**(0x1d - 3)
        return lowest / self.target()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_11">Exercise 11</h4>
<div class="paragraph">
<p>Write the <code>check_pow</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def check_pow(self):
        sha = hash256(self.serialize())
        proof = little_endian_to_int(sha)
        return proof &lt; self.target()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_12">Exercise 12</h4>
<div class="paragraph">
<p>Calculate the new bits given the first and last blocks of this 2,016-block difficulty adjustment period:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Block 471744:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>000000203471101bbda3fe307664b3283a9ef0e97d9a38a7eacd88000000000000000000
10c8aba8479bbaa5e0848152fd3c2289ca50e1c3e58c9a4faaafbdf5803c5448ddb84559
7e8b0118e43a81d3</code></pre>
</div>
</div>
</li>
<li>
<p>Block 473759:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>02000020f1472d9db4b563c35f97c428ac903f23b7fc055d1cfc26000000000000000000
b3f449fcbe1bc4cfbcb8283a0d2c037f961a3fdf2b8bedc144973735eea707e126425859
7e8b0118e5f00474</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from block import Block
&gt;&gt;&gt; from helper import TWO_WEEKS
&gt;&gt;&gt; from helper import target_to_bits
&gt;&gt;&gt; block1_hex = '000000203471101bbda3fe307664b3283a9ef0e97d9a38a7eacd88000000\
00000000000010c8aba8479bbaa5e0848152fd3c2289ca50e1c3e58c9a4faaafbdf5803c5448dd\
b845597e8b0118e43a81d3'
&gt;&gt;&gt; block2_hex = '02000020f1472d9db4b563c35f97c428ac903f23b7fc055d1cfc26000000\
000000000000b3f449fcbe1bc4cfbcb8283a0d2c037f961a3fdf2b8bedc144973735eea707e126\
4258597e8b0118e5f00474'
&gt;&gt;&gt; last_block = Block.parse(BytesIO(bytes.fromhex(block1_hex)))
&gt;&gt;&gt; first_block = Block.parse(BytesIO(bytes.fromhex(block2_hex)))
&gt;&gt;&gt; time_differential = last_block.timestamp - first_block.timestamp
&gt;&gt;&gt; if time_differential &gt; TWO_WEEKS * 4:
...     time_differential = TWO_WEEKS * 4
&gt;&gt;&gt; if time_differential &lt; TWO_WEEKS // 4:
...     time_differential = TWO_WEEKS // 4
&gt;&gt;&gt; new_target = last_block.target() * time_differential // TWO_WEEKS
&gt;&gt;&gt; new_bits = target_to_bits(new_target)
&gt;&gt;&gt; print(new_bits.hex())
80df6217</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_13">Exercise 13</h4>
<div class="paragraph">
<p>Write the <code>calculate_new_bits</code> function in <em>helper.py</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def calculate_new_bits(previous_bits, time_differential):
    if time_differential &gt; TWO_WEEKS * 4:
        time_differential = TWO_WEEKS * 4
    if time_differential &lt; TWO_WEEKS // 4:
        time_differential = TWO_WEEKS // 4
    new_target = bits_to_target(previous_bits) * time_differential // TWO_WEEKS
    return target_to_bits(new_target)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_networking_networking"><a href="#chapter_networking">[chapter_networking]</a>: Networking</h3>
<div class="sect3">
<h4 id="_exercise_1_10">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>parse</code> method for <code>NetworkEnvelope</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@classmethod
def parse(cls, s, testnet=False):
    magic = s.read(4)
    if magic == b'':
        raise IOError('Connection reset!')
    if testnet:
        expected_magic = TESTNET_NETWORK_MAGIC
    else:
        expected_magic = NETWORK_MAGIC
    if magic != expected_magic:
        raise SyntaxError('magic is not right {} vs {}'.format(magic.hex(),
          expected_magic.hex()))
    command = s.read(12)
    command = command.strip(b'\x00')
    payload_length = little_endian_to_int(s.read(4))
    checksum = s.read(4)
    payload = s.read(payload_length)
    calculated_checksum = hash256(payload)[:4]
    if calculated_checksum != checksum:
        raise IOError('checksum does not match')
    return cls(command, payload, testnet=testnet)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_10">Exercise 2</h4>
<div class="paragraph">
<p>Determine what this network message is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>f9beb4d976657261636b000000000000000000005df6e0e2</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class NetworkEnvelope:
...
    &gt;&gt;&gt; from network import NetworkEnvelope
    &gt;&gt;&gt; from io import BytesIO
    &gt;&gt;&gt; message_hex = 'f9beb4d976657261636b000000000000000000005df6e0e2'
    &gt;&gt;&gt; stream = BytesIO(bytes.fromhex(message_hex))
    &gt;&gt;&gt; envelope = NetworkEnvelope.parse(stream)
    &gt;&gt;&gt; print(envelope.command)
    b'verack'
    &gt;&gt;&gt; print(envelope.payload)
    b''</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_10">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for <code>NetworkEnvelope</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class NetworkEnvelope:
...
    def serialize(self):
        result = self.magic
        result += self.command + b'\x00' * (12 - len(self.command))
        result += int_to_little_endian(len(self.payload), 4)
        result += hash256(self.payload)[:4]
        result += self.payload
        return result</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_10">Exercise 4</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for <code>VersionMessage</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class VersionMessage:
...
    def serialize(self):
        result = int_to_little_endian(self.version, 4)
        result += int_to_little_endian(self.services, 8)
        result += int_to_little_endian(self.timestamp, 8)
        result += int_to_little_endian(self.receiver_services, 8)
        result += b'\x00' * 10 + b'\xff\xff' + self.receiver_ip
        result += self.receiver_port.to_bytes(2, 'big')
        result += int_to_little_endian(self.sender_services, 8)
        result += b'\x00' * 10 + b'\xff\xff' + self.sender_ip
        result += self.sender_port.to_bytes(2, 'big')
        result += self.nonce
        result += encode_varint(len(self.user_agent))
        result += self.user_agent
        result += int_to_little_endian(self.latest_block, 4)
        if self.relay:
            result += b'\x01'
        else:
            result += b'\x00'
        return result</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_9">Exercise 5</h4>
<div class="paragraph">
<p>Write the <code>handshake</code> method for <code>SimpleNode</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class SimpleNode:
...
    def handshake(self):
        version = VersionMessage()
        self.send(version)
        self.wait_for(VerAckMessage)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_7">Exercise 6</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for <code>GetHeadersMessage</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class GetHeadersMessage:
...
    def serialize(self):
        result = int_to_little_endian(self.version, 4)
        result += encode_varint(self.num_hashes)
        result += self.start_block[::-1]
        result += self.end_block[::-1]
        return result</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_spv_simplified_payment_verification"><a href="#chapter_spv">[chapter_spv]</a>: Simplified Payment Verification</h3>
<div class="sect3">
<h4 id="_exercise_1_11">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>merkle_parent</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def merkle_parent(hash1, hash2):
    '''Takes the binary hashes and calculates the hash256'''
    return hash256(hash1 + hash2)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_11">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>merkle_parent_level</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def merkle_parent_level(hashes):
    '''Takes a list of binary hashes and returns a list that's half
    the length'''
    if len(hashes) == 1:
        raise RuntimeError('Cannot take a parent level with only 1 item')
    if len(hashes) % 2 == 1:
        hashes.append(hashes[-1])
    parent_level = []
    for i in range(0, len(hashes), 2):
        parent = merkle_parent(hashes[i], hashes[i + 1])
        parent_level.append(parent)
    return parent_level</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_11">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>merkle_root</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def merkle_root(hashes):
    '''Takes a list of binary hashes and returns the merkle root
    '''
    current_level = hashes
    while len(current_level) &gt; 1:
        current_level = merkle_parent_level(current_level)
    return current_level[0]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_11">Exercise 4</h4>
<div class="paragraph">
<p>Write the <code>validate_merkle_root</code> method for <code>Block</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Block:
...
    def validate_merkle_root(self):
        hashes = [h[::-1] for h in self.tx_hashes]
        root = merkle_root(hashes)
        return root[::-1] == self.merkle_root</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_10">Exercise 5</h4>
<div class="paragraph">
<p>Create an empty Merkle Tree with 27 items and print each level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; import math
&gt;&gt;&gt; total = 27
&gt;&gt;&gt; max_depth = math.ceil(math.log(total, 2))
&gt;&gt;&gt; merkle_tree = []
&gt;&gt;&gt; for depth in range(max_depth + 1):
...     num_items = math.ceil(total / 2**(max_depth - depth))
...     level_hashes = [None] * num_items
...     merkle_tree.append(level_hashes)
&gt;&gt;&gt; for level in merkle_tree:
...     print(level)
[None]
[None, None]
[None, None, None, None]
[None, None, None, None, None, None, None]
[None, None, None, None, None, None, None, None, None, None, None, None, None,\
 None]
[None, None, None, None, None, None, None, None, None, None, None, None, None,\
 None, None, None, None, None, None, None, None, None, None, None, None, None,\
 None]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_8">Exercise 6</h4>
<div class="paragraph">
<p>Write the <code>parse</code> method for <code>MerkleBlock</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MerkleBlock:
...
    @classmethod
    def parse(cls, s):
        version = little_endian_to_int(s.read(4))
        prev_block = s.read(32)[::-1]
        merkle_root = s.read(32)[::-1]
        timestamp = little_endian_to_int(s.read(4))
        bits = s.read(4)
        nonce = s.read(4)
        total = little_endian_to_int(s.read(4))
        num_hashes = read_varint(s)
        hashes = []
        for _ in range(num_hashes):
            hashes.append(s.read(32)[::-1])
        flags_length = read_varint(s)
        flags = s.read(flags_length)
        return cls(version, prev_block, merkle_root, timestamp, bits,
                   nonce, total, hashes, flags)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_7_6">Exercise 7</h4>
<div class="paragraph">
<p>Write the <code>is_valid</code> method for <code>MerkleBlock</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MerkleBlock:
...
    def is_valid(self):
        flag_bits = bytes_to_bit_field(self.flags)
        hashes = [h[::-1] for h in self.hashes]
        merkle_tree = MerkleTree(self.total)
        merkle_tree.populate_tree(flag_bits, hashes)
        return merkle_tree.root()[::-1] == self.merkle_root</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_chapter_bloom_filters_bloom_filters"><a href="#chapter_bloom_filters">[chapter_bloom_filters]</a>: Bloom Filters</h3>
<div class="sect3">
<h4 id="_exercise_1_12">Exercise 1</h4>
<div class="paragraph">
<p>Calculate the Bloom Filter for "hello world" and "goodbye" using the hash160 hash function over a bit field of 10.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import hash160
&gt;&gt;&gt; bit_field_size = 10
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; for item in (b'hello world', b'goodbye'):
...     h = hash160(item)
...     bit = int.from_bytes(h, 'big') % bit_field_size
...     bit_field[bit] = 1
&gt;&gt;&gt; print(bit_field)
[1, 1, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2_12">Exercise 2</h4>
<div class="paragraph">
<p>Given a Bloom Filter with <code>size=10</code>, <code>function_count=5</code>, <code>tweak=99</code>, what are the bytes that are set after adding these items? (Use <code>bit_field_to_bytes</code> to convert to bytes.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>b&#8217;Hello World'</code></p>
</li>
<li>
<p><code>b&#8217;Goodbye!'</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from bloomfilter import BloomFilter, BIP37_CONSTANT
&gt;&gt;&gt; from helper import bit_field_to_bytes, murmur3
&gt;&gt;&gt; field_size = 10
&gt;&gt;&gt; function_count = 5
&gt;&gt;&gt; tweak = 99
&gt;&gt;&gt; items = (b'Hello World',  b'Goodbye!')
&gt;&gt;&gt; bit_field_size = field_size * 8
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; for item in items:
...     for i in range(function_count):
...         seed = i * BIP37_CONSTANT + tweak
...         h = murmur3(item, seed=seed)
...         bit = h % bit_field_size
...         bit_field[bit] = 1
&gt;&gt;&gt; print(bit_field_to_bytes(bit_field).hex())
4000600a080000010940</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3_12">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>add</code> method for <code>BloomFilter</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class BloomFilter:
...
    def add(self, item):
        for i in range(self.function_count):
            seed = i * BIP37_CONSTANT + self.tweak
            h = murmur3(item, seed=seed)
            bit = h % (self.size * 8)
            self.bit_field[bit] = 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4_12">Exercise 4</h4>
<div class="paragraph">
<p>Write the  <code>filterload</code> method for the <code>BloomFilter</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class BloomFilter:
...
    def filterload(self, flag=1):
        payload = encode_varint(self.size)
        payload += self.filter_bytes()
        payload += int_to_little_endian(self.function_count, 4)
        payload += int_to_little_endian(self.tweak, 4)
        payload += int_to_little_endian(flag, 1)
        return GenericMessage(b'filterload', payload)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5_11">Exercise 5</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for the <code>GetDataMessage</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class GetDataMessage:
...
    def serialize(self):
        result = encode_varint(len(self.data))
        for data_type, identifier in self.data:
            result += int_to_little_endian(data_type, 4)
            result += identifier[::-1]
        return result</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6_9">Exercise 6</h4>
<div class="paragraph">
<p>Get the current testnet block ID, send yourself some testnet coins, find the UTXO corresponding to the testnet coins <em>without using a block explorer</em>, create a transaction using that UTXO as an input, and broadcast the tx message on the  testnet network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; import time
&gt;&gt;&gt; from block import Block
&gt;&gt;&gt; from bloomfilter import BloomFilter
&gt;&gt;&gt; from ecc import PrivateKey
&gt;&gt;&gt; from helper import (
...     decode_base58,
...     encode_varint,
...     hash256,
...     little_endian_to_int,
...     read_varint,
... )
&gt;&gt;&gt; from merkleblock import MerkleBlock
&gt;&gt;&gt; from network import (
...     GetDataMessage,
...     GetHeadersMessage,
...     HeadersMessage,
...     NetworkEnvelope,
...     SimpleNode,
...     TX_DATA_TYPE,
...     FILTERED_BLOCK_DATA_TYPE,
... )
&gt;&gt;&gt; from script import p2pkh_script, Script
&gt;&gt;&gt; from tx import Tx, TxIn, TxOut
&gt;&gt;&gt; last_block_hex = '00000000000000a03f9432ac63813c6710bfe41712ac5ef6faab093f\
e2917636'
&gt;&gt;&gt; secret = little_endian_to_int(hash256(b'Jimmy Song'))
&gt;&gt;&gt; private_key = PrivateKey(secret=secret)
&gt;&gt;&gt; addr = private_key.point.address(testnet=True)
&gt;&gt;&gt; h160 = decode_base58(addr)
&gt;&gt;&gt; target_address = 'mwJn1YPMq7y5F8J3LkC5Hxg9PHyZ5K4cFv'
&gt;&gt;&gt; target_h160 = decode_base58(target_address)
&gt;&gt;&gt; target_script = p2pkh_script(target_h160)
&gt;&gt;&gt; fee = 5000  # fee in satoshis
&gt;&gt;&gt; # connect to testnet.programmingbitcoin.com in testnet mode
&gt;&gt;&gt; node = SimpleNode('testnet.programmingbitcoin.com', testnet=True, logging=\
False)
&gt;&gt;&gt; # Create a Bloom Filter of size 30 and 5 functions. Add a tweak.
&gt;&gt;&gt; bf = BloomFilter(30, 5, 90210)
&gt;&gt;&gt; # add the h160 to the Bloom Filter
&gt;&gt;&gt; bf.add(h160)
&gt;&gt;&gt; # complete the handshake
&gt;&gt;&gt; node.handshake()
&gt;&gt;&gt; # load the Bloom Filter with the filterload command
&gt;&gt;&gt; node.send(bf.filterload())
&gt;&gt;&gt; # set start block to last_block from above
&gt;&gt;&gt; start_block = bytes.fromhex(last_block_hex)
&gt;&gt;&gt; # send a getheaders message with the starting block
&gt;&gt;&gt; getheaders = GetHeadersMessage(start_block=start_block)
&gt;&gt;&gt; node.send(getheaders)
&gt;&gt;&gt; # wait for the headers message
&gt;&gt;&gt; headers = node.wait_for(HeadersMessage)
&gt;&gt;&gt; # store the last block as None
&gt;&gt;&gt; last_block = None
&gt;&gt;&gt; # initialize the GetDataMessage
&gt;&gt;&gt; getdata = GetDataMessage()
&gt;&gt;&gt; # loop through the blocks in the headers
&gt;&gt;&gt; for b in headers.blocks:
...     # check that the proof of work on the block is valid
...     if not b.check_pow():
...         raise RuntimeError('proof of work is invalid')
...     # check that this block's prev_block is the last block
...     if last_block is not None and b.prev_block != last_block:
...         raise RuntimeError('chain broken')
...     # add a new item to the getdata message
...     # should be FILTERED_BLOCK_DATA_TYPE and block hash
...     getdata.add_data(FILTERED_BLOCK_DATA_TYPE, b.hash())
...     # set the last block to the current hash
...     last_block = b.hash()
&gt;&gt;&gt; # send the getdata message
&gt;&gt;&gt; node.send(getdata)
&gt;&gt;&gt; # initialize prev_tx, prev_index, and prev_amount to None
&gt;&gt;&gt; prev_tx, prev_index, prev_amount = None, None, None
&gt;&gt;&gt; # loop while prev_tx is None
&gt;&gt;&gt; while prev_tx is None:
...     # wait for the merkleblock or tx commands
...     message = node.wait_for(MerkleBlock, Tx)
...     # if we have the merkleblock command
...     if message.command == b'merkleblock':
...         # check that the MerkleBlock is valid
...         if not message.is_valid():
...             raise RuntimeError('invalid merkle proof')
...     # else we have the tx command
...     else:
...         # set the tx's testnet to be True
...         message.testnet = True
...         # loop through the tx outs
...         for i, tx_out in enumerate(message.tx_outs):
...             # if our output has the same address as our address we found it
...             if tx_out.script_pubkey.address(testnet=True) == addr:
...                 # we found our utxo; set prev_tx, prev_index, and tx
...                 prev_tx = message.hash()
...                 prev_index = i
...                 prev_amount = tx_out.amount
...                 print('found: {}:{}'.format(prev_tx.hex(), prev_index))
found: b2cddd41d18d00910f88c31aa58c6816a190b8fc30fe7c665e1cd2ec60efdf3f:7
&gt;&gt;&gt; # create the TxIn
&gt;&gt;&gt; tx_in = TxIn(prev_tx, prev_index)
&gt;&gt;&gt; # calculate the output amount (previous amount minus the fee)
&gt;&gt;&gt; output_amount = prev_amount - fee
&gt;&gt;&gt; # create a new TxOut to the target script with the output amount
&gt;&gt;&gt; tx_out = TxOut(output_amount, target_script)
&gt;&gt;&gt; # create a new transaction with the one input and one output
&gt;&gt;&gt; tx_obj = Tx(1, [tx_in], [tx_out], 0, testnet=True)
&gt;&gt;&gt; # sign the only input of the transaction
&gt;&gt;&gt; print(tx_obj.sign_input(0, private_key))
True
&gt;&gt;&gt; # serialize and hex to see what it looks like
&gt;&gt;&gt; print(tx_obj.serialize().hex())
01000000013fdfef60ecd21c5e667cfe30fcb890a116688ca51ac3880f91008dd141ddcdb20700\
00006b483045022100ff77d2559261df5490ed00d231099c4b8ea867e6ccfe8e3e6d077313ed4f\
1428022033a1db8d69eb0dc376f89684d1ed1be75719888090388a16f1e8eedeb8067768012103\
dc585d46cfca73f3a75ba1ef0c5756a21c1924587480700c6eb64e3f75d22083ffffffff019334\
e500000000001976a914ad346f8eb57dee9a37981716e498120ae80e44f788ac00000000
&gt;&gt;&gt; # send this signed transaction on the network
&gt;&gt;&gt; node.send(tx_obj)
&gt;&gt;&gt; # wait a sec so this message goes through with time.sleep(1)
&gt;&gt;&gt; time.sleep(1)
&gt;&gt;&gt; # now ask for this transaction from the other node
&gt;&gt;&gt; # create a GetDataMessage
&gt;&gt;&gt; getdata = GetDataMessage()
&gt;&gt;&gt; # ask for our transaction by adding it to the message
&gt;&gt;&gt; getdata.add_data(TX_DATA_TYPE, tx_obj.hash())
&gt;&gt;&gt; # send the message
&gt;&gt;&gt; node.send(getdata)
&gt;&gt;&gt; # now wait for a Tx response
&gt;&gt;&gt; received_tx = node.wait_for(Tx)
&gt;&gt;&gt; # if the received tx has the same id as our tx, we are done!
&gt;&gt;&gt; if received_tx.id() == tx_obj.id():
...     print('success!')
success!</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-06-19 11:10:39 -0400
</div>
</div>
</body>
</html>